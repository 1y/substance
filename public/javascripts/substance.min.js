var Notifications={CONNECTED:{message:"Just established a server connection.",type:"info"},AUTHENTICATED:{message:"Successfully authenticated.",type:"success"},AUTHENTICATION_FAILED:{message:"Authentication failed.",type:"error"},SIGNUP_FAILED:{message:"User Registration failed. Check your input",type:"error"},DOCUMENT_LOADING:{message:"Loading document ...",type:"info"},DOCUMENT_LOADED:{message:"Document successfully loaded.",type:"success"},DOCUMENT_LOADING_FAILED:{message:"An error ocurred during loading.",
type:"error"},DOCUMENTS_LOADING:{message:"Loading available documents ...",type:"info"},DOCUMENTS_LOADED:{message:"Documents fetched.",type:"success"},DOCUMENTS_LOADING_FAILED:{message:"An error occured during loading documents",type:"error"},BLANK_DOCUMENT:{message:"You are now editing a blank document.",type:"info"},DOCUMENT_SAVING:{message:"Saving document ...",type:"info"},DOCUMENT_SAVED:{message:"The document has been stored in the repository.",type:"success"},DOCUMENT_SAVING_FAILED:{message:"Error during saving.",
type:"error"},SYNCHRONIZING:{message:"Synchronizing with server ...",type:"info"},SYNCHRONIZED:{message:"Successfully synchronized with server",type:"info"},SYNCHRONIZING_FAILED:{message:"Failed to synchronize with server",type:"error"},DOCUMENT_INVALID:{message:"The document is invalid. Make sure that you've set a correct name for it.",type:"error"},DOCUMENT_ALREADY_EXISTS:{message:"This document name is already taken.",type:"error"},DOCUMENT_DELETING:{message:"Deleting document ...",type:"info"},
DOCUMENT_DELETED:{message:"The document has been deleted.",type:"success"},DOCUMENT_DELETING_FAILED:{message:"Error during deletion.",type:"error"},NEW_COLLABORATOR:{message:"A new collaborator just went online.",type:"info"},EXIT_COLLABORATOR:{message:"One collaborator just left.",type:"info"}};Backbone.Notifier=function(a){a||(a={});this.initialize&&this.initialize(a)};_.extend(Backbone.Notifier.prototype,Backbone.Events,{notify:function(a){this.trigger("message:arrived",a)}});var notifier=new Backbone.Notifier;
notifier.bind("message:arrived",function(a){var b=$('<p class="notification"><span>'+a.type+":</span>"+a.message+"</p>");$("#notifications .wrapper").append(b);if(a.message.indexOf("...")!==-1)b.addClass("activity");else{$("#notifications .wrapper p.activity").remove();setTimeout(function(){b.remove()},4E3)}});
(function(){_.date=function(a){var b=Date.parse(a),c=0,d;if(isNaN(b)&&(d=/^(\d{4}|[+\-]\d{6})-(\d{2})-(\d{2})(?:[T ](\d{2}):(\d{2})(?::(\d{2})(?:\.(\d{3,}))?)?(?:(Z)|([+\-])(\d{2})(?::?(\d{2}))?))?/.exec(a))){if(d[8]!=="Z"){c=+d[10]*60+ +d[11];if(d[9]==="+")c=0-c}b=Date.UTC(+d[1],+d[2]-1,+d[3],+d[4],+d[5]+c,+d[6],+d[7].substr(0,3))}return(new Date(b)).toDateString()}})();if(!window.console)window.console={log:function(){}};var Helpers={};
Helpers.renderTemplate=_.renderTemplate=function(a,b,c){source=$("script[name="+a+"]").html();return Handlebars.compile(source)(b,c||{})};
_.slug=function(a){a=a.replace(/^\s+|\s+$/g,"");a=a.toLowerCase();for(var b=0;b<28;b++)a=a.replace(RegExp("\u00e0\u00e1\u00e4\u00e2\u00e8\u00e9\u00eb\u00ea\u00ec\u00ed\u00ef\u00ee\u00f2\u00f3\u00f6\u00f4\u00f9\u00fa\u00fc\u00fb\u00f1\u00e7\u00b7/_,:;".charAt(b),"g"),"aaaaeeeeiiiioooouuuunc------".charAt(b));return a=a.replace(/[^a-z0-9 -]/g,"").replace(/\s+/g,"-").replace(/-+/g,"-")};_.scrollTop=function(){return document.body.scrollTop||document.documentElement.scrollTop};
_.tpl=function(a,b){source=$("script[name="+a+"]").html();return _.template(source,b)};_.fullSelection=function(a){var b;if(document.createRange){b=document.createRange();b.selectNodeContents(a);a=window.getSelection();a.removeAllRanges();a.addRange(b)}else if(document.selection){b=document.body.createTextRange();b.moveToElementText(a);b.collapse(false);b.select()}};_.prettyDate=function(a){return jQuery.timeago(a)};
_.stripTags=function(a,b){b=(((b||"")+"").toLowerCase().match(/<[a-z][a-z0-9]*>/g)||[]).join("");return a.replace(/<!--[\s\S]*?--\>|<\?(?:php)?[\s\S]*?\?>/gi,"").replace(/<\/?([a-z][a-z0-9]*)\b[^>]*>/gi,function(c,d){return b.indexOf("<"+d.toLowerCase()+">")>-1?c:""})};
var ContentNode={getTeaser:function(a){if(a.type.key==="/type/section")return a.get("name")?a.get("name").trim().substring(0,15)+" ...":"Section";else if(a.type.key==="/type/text")return _.stripTags(a.get("content")).trim().substring(0,15)+" ...";else if(a.type.key==="/type/image")return"Image";else if(a.type.key==="/type/resource")return"Resource";else if(a.type.key==="/type/quote")return"Quote";else if(a.type.key==="/type/code")return"Code";return"N/A"}},renderControls=function(a,b,c,d,e){function f(g,
i,h){function j(m,p){function t(l){if(!(l.nodeType==="/type/section"&&l.level>3))if(l.nodeType==="/type/section"){var r=k.get(l.nodeType);r.push(l);r.sort(function(u,v){return u.level===v.level?0:u.level<v.level?-1:1});k.set(l.nodeType,r)}else if(!k.get(l.nodeType)[0]||l.level>k.get(l.nodeType)[0].level)k.set(l.nodeType,[l])}var q=parseInt($("#"+m.html_id).attr("level"));n=m;m.level=q;q<=3&&o.push(m);if(m.all("children")&&m.all("children").length===0&&i==="after"){var s=m.properties().get("children").expectedTypes;
_.each(s,function(l){t({node:m._id,parentNode:p?p._id:null,nodeType:l,nodeTypeName:graph.get(l).name,insertionType:"child",level:q+1})})}if(p){s=p.properties().get("children").expectedTypes;_.each(s,function(l){t({node:m._id,parentNode:p?p._id:null,nodeType:l,nodeTypeName:graph.get(l).name,insertionType:"sibling",level:q})})}h&&m.all("children")&&m.all("children").length>0&&j(m.all("children").last(),m);return k}var k=new Data.Hash,n=null,o=[];k.set("/type/section",[]);k.set("/type/text",[]);k.set("/type/image",
[]);k.set("/type/resource",[]);k.set("/type/quote",[]);k.set("/type/code",[]);j(g,d);g=n.all("children")&&n.all("children").length===0&&i==="after"?"child":"sibling";return _.tpl("controls",{node:n,insertion_type:g,destination:i,actions:k,path:o})}if(d){b&&$(f(a,"before")).insertBefore($("#"+a.html_id));if(!c||d.types().get("/type/document"))$(f(a,"after",true)).insertAfter($("#"+a.html_id))}else{$("#document .controls").remove();if(!a.all("children")||a.all("children").length===0)$(f(a,"after")).appendTo($("#"+
a.html_id))}a.all("children")&&a.all("children").each(function(g,i,h){i=h===0;h=h===a.all("children").length-1;renderControls(g,i,h,a,e+1)})},HTMLRenderer=function(a,b,c){var d={"/type/document":function(e,f,g){var i="";(f=e.all("children"))&&f.each(function(h,j){h.type||console.log(e._id+"has an unreferenced child"+j);i+=d[h.type._id](h,e,g+1)});return _.tpl("document",{node:e,toc:(new TOCRenderer(e)).render(),content:i,edit:app.document.mode==="edit",title:app.document.mode==="edit"?e.get("title"):
e.get("title")||"Untitled",lead:e.get("lead"),empty_lead:app.document.mode==="edit"&&(!e.get("lead")||e.get("lead")===""),empty_title:app.document.mode==="edit"&&(!e.get("title")||e.get("title")===""),level:g})},"/type/story":function(e,f,g){return d["/type/document"](e,f,g)},"/type/conversation":function(e,f,g){return d["/type/document"](e,f,g)},"/type/article":function(e,f,g){return d["/type/document"](e,f,g)},"/type/manual":function(e,f,g){return d["/type/document"](e,f,g)},"/type/qaa":function(e,
f,g){return d["/type/document"](e,f,g)},"/type/section":function(e,f,g){var i="";e.all("children")&&e.all("children").each(function(h){i+=d[h.type._id](h,e,g+1)});return Helpers.renderTemplate("section",{node:e,comments:e.get("comment_count"),parent:f,content:i,heading_level:g,level:g,edit:app.document.mode==="edit",name:e.get("name"),empty:app.document.mode==="edit"&&(!e.get("name")||e.get("name")==="")})},"/type/text":function(e,f,g){return _.tpl("text",{node:e,comments:e.get("comment_count"),parent:f,
edit:app.document.mode==="edit",content:e.get("content"),empty:app.document.mode==="edit"&&(!e.get("content")||e.get("content")==="<p></p>"),level:g})},"/type/quote":function(e,f,g){return Helpers.renderTemplate("quote",{node:e,comments:e.get("comment_count"),parent:f,edit:app.document.mode==="edit",content:e.get("content"),author:e.get("author"),empty_content:app.document.mode==="edit"&&(!e.get("content")||e.get("content")===""),empty_author:app.document.mode==="edit"&&(!e.get("author")||e.get("author")===
""),level:g})},"/type/code":function(e,f,g){return Helpers.renderTemplate("code",{node:e,comments:e.get("comment_count"),parent:f,edit:app.document.mode==="edit",content:e.get("content"),empty:app.document.mode==="edit"&&(!e.get("content")||e.get("content")===""),level:g})},"/type/question":function(e,f,g){return Helpers.renderTemplate("question",{node:e,comments:e.get("comment_count"),parent:f,edit:app.document.mode==="edit",content:e.get("content"),empty:app.document.mode==="edit"&&(!e.get("content")||
e.get("content")===""),level:g})},"/type/answer":function(e,f,g){return Helpers.renderTemplate("answer",{node:e,comments:e.get("comment_count"),parent:f,edit:app.document.mode==="edit",content:e.get("content"),empty:app.document.mode==="edit"&&(!e.get("content")||e.get("content")===""),level:g})},"/type/image":function(e,f,g){return _.tpl("image",{node:e,comments:e.get("comment_count"),parent:f,edit:app.document.mode==="edit",url:e.get("url"),original_url:e.get("original_url"),level:g,empty:app.document.mode===
"edit"&&(!e.get("caption")||e.get("caption")===""),caption:e.get("caption"),transloadit_params:config.transloadit})},"/type/resource":function(e,f,g){return Helpers.renderTemplate("resource",{node:e,comments:e.get("comment_count"),parent:f,edit:app.document.mode==="edit",url:e.get("url"),level:g,empty:app.document.mode==="edit"&&(!e.get("caption")||e.get("caption")===""),caption:e.get("caption"),transloadit_params:config.transloadit})},"/type/visualization":function(e,f,g){return Helpers.renderTemplate("visualization",
{node:e,comments:e.get("comment_count"),parent:f,edit:app.document.mode==="edit",visualization_type:e.get("visualization_type"),data_source:e.get("data_source"),level:g})}};return{render:function(){return d[a.type._id](a,b,parseInt(c))}}},TOCRenderer=function(a){var b={"/type/document":function(c){content="<ol>";c.all("children").each(function(d){if(d.type.key==="/type/section"){content+='<li><a class="toc-item" node="'+d.html_id+'" href="#'+a.get("creator")._id.split("/")[2]+"/"+a.get("name")+"/"+
d.html_id+'">'+d.get("name")+"</a>";content+=b["/type/document"](d);content+="</li>"}});content+="</ol>";return content},"/type/story":function(c){return b["/type/document"](c)},"/type/conversation":function(){return""},"/type/manual":function(c,d){return b["/type/document"](c,d)},"/type/article":function(c,d){return b["/type/document"](c,d)},"/type/qaa":function(c,d){return b["/type/document"](c,d)}};return{render:function(){return b[a.type._id](a)}}},DocumentEditor=Backbone.View.extend({events:{"keydown .property":"updateNode"},
initialize:function(){function a(){editor.activate(c.$node,{multiline:false,markup:false,placeholder:"Enter Title"});editor.bind("changed",function(){c.updateNode({title:editor.content()})})}function b(){editor.activate(c.$lead,{multiline:false,markup:false,placeholder:"Enter lead"});editor.bind("changed",function(){c.updateNode({lead:editor.content()})})}var c=this;this.$node=$("#"+app.document.selectedNode.html_id+" > .document-title.content").unbind();this.$lead=$("#"+app.document.selectedNode.html_id+
" #document_lead").unbind();c.$node.bind("click",a);c.$lead.bind("click",b);document.activeElement===c.$node[0]?a():b();return true},updateNode:function(a){app.document.updateSelectedNode(a);app.document.trigger("changed")}}),SectionEditor=Backbone.View.extend({initialize:function(){this.render();this.$node=$("#"+app.document.selectedNode.html_id+" > .content").attr("contenteditable",true).unbind();editor.activate(this.$node,{placeholder:"Enter Section Name",multiline:false,markup:false});editor.bind("changed",
function(){app.document.updateSelectedNode({name:editor.content()})})},render:function(){}}),TextEditor=Backbone.View.extend({events:{},initialize:function(){this.render();this.$content=this.$("div.content");editor.activate(this.$content,{placeholder:"Enter Text",controlsTarget:$(this.el)});editor.bind("changed",function(){app.document.updateSelectedNode({content:editor.content()})})},render:function(){}}),QuoteEditor=Backbone.View.extend({events:{},initialize:function(){function a(){editor.activate(c.$content,
{multiline:false,markup:false,placeholder:"Enter Quote"});editor.bind("changed",function(){c.updateNode({content:editor.content()})})}function b(){editor.activate(c.$author,{multiline:false,markup:false,placeholder:"Enter Author"});editor.bind("changed",function(){c.updateNode({author:editor.content()})})}var c=this;this.$content=this.$(".quote-content").unbind();this.$author=this.$(".quote-author").unbind();c.$content.bind("click",a);c.$author.bind("click",b);document.activeElement===c.$author[0]?
b():a();return true},updateNode:function(a){app.document.updateSelectedNode(a);app.document.trigger("changed")},render:function(){}}),CodeEditor=Backbone.View.extend({events:{},initialize:function(){this.render();this.$content=this.$(".content");editor.activate(this.$content,{placeholder:"Enter Code",controlsTarget:$("#document_actions"),markup:false});editor.bind("changed",function(){app.document.updateSelectedNode({content:editor.content()})})},render:function(){}}),QuestionEditor=Backbone.View.extend({events:{},
initialize:function(){this.render();this.$content=this.$(".content");editor.activate(this.$content,{multiline:false,markup:false});editor.bind("changed",function(){app.document.updateSelectedNode({content:editor.content()})})},render:function(){}}),AnswerEditor=Backbone.View.extend({events:{},initialize:function(){var a=this;this.render();this.$content=this.$(".content");editor.activate(this.$content,{placeholder:"Enter Answer",controlsTarget:$("#document_actions")});editor.bind("changed",function(){a.updateNode()})},
updateNode:function(){setTimeout(function(){app.document.updateSelectedNode({content:editor.content()})},5)},render:function(){}}),ImageEditor=Backbone.View.extend({events:{"change .image-file ":"upload"},upload:function(){this.$(".upload-image-form").submit()},initialize:function(){var a=this;this.$caption=this.$(".caption");editor.activate(this.$caption,{placeholder:"Enter Caption",multiline:false,markup:false});editor.bind("changed",function(){app.document.updateSelectedNode({caption:editor.content()})});
this.$(".upload-image-form").transloadit({modal:false,wait:true,autoSubmit:false,onProgress:function(b,c){var d=parseInt(b/c*100);d>=0||(d=0);a.$(".image-progress .label").html("Uploading ... "+d+"%");a.$(".progress-bar").attr("style","width:"+d+"%")},onStart:function(){a.$(".image-progress").show();a.$(".info").hide();a.$(".image-progress .label").html("Uploading ...");a.$(".progress-bar").attr("style","width: 0%")},onSuccess:function(b){if(b.results.web_version&&b.results.web_version[1]&&b.results.web_version[1].url){app.document.updateSelectedNode({url:b.results.web_version[1].url,
original_url:b.results.print_version[1].url,dirty:true});app.document.reset();a.$(".progress-container").hide();a.$(".info").show()}else{a.$(".image-progress .label").html("Invalid image. Skipping ...");a.$(".progress-container").hide();setTimeout(function(){app.document.reset();a.$(".info").show()},3E3)}}})},render:function(){}}),ResourceEditor=Backbone.View.extend({events:{"keydown .resource-url":"update"},resourceExists:function(a,b){var c=new Image;c.onload=function(){b(null)};c.onerror=function(){b("not found")};
c.src=a},update:function(){var a=this;setTimeout(function(){var b=a.$(".resource-url").val();a.resourceExists(b,function(c){if(c)a.$(".status").replaceWith('<div class="status">Invalid URL</div>');else{a.$(".resource-content img").attr("src",b);a.$(".status").replaceWith('<div class="status image">Image</div>');app.document.updateSelectedNode({url:b})}})},500)},initialize:function(){this.pendingCheck=false;this.$caption=this.$(".caption");editor.activate(this.$caption,{placeholder:"Enter Caption",
multiline:false,markup:false});editor.bind("changed",function(){app.document.updateSelectedNode({caption:editor.content()})})},render:function(){}}),UI={};
UI.StringEditor=Backbone.View.extend({events:{"change input":"updateValue"},initialize:function(a){var b=this;this._value=a.value;this.bind("changed",function(){b.render()});this.render()},updateValue:function(){this._value=this.$("input[name=value]").val();this.trigger("changed");this.render();return false},value:function(){return this._value},render:function(){$(this.el).html(_.renderTemplate("string_editor",{value:this._value}))}});
UI.MultiStringEditor=Backbone.View.extend({events:{"submit form":"newItem","click a.remove-item":"removeItem","click .available-item a":"selectAvailableItem","keydown input":"inputChange","click input":"initInput","blur input":"reset"},initialize:function(a){var b=this;this._items=a.items||[];this._availableItems=a.availableItems;this.bind("changed",function(){b.render()});this.render()},initInput:function(){},reset:function(){this.$(".available-items").empty()},inputChange:function(a){var b=this,
c=this.$(".available-item");if(a.keyCode===40){if(this.selectedIndex<c.length-1)this.selectedIndex+=1;this.teaseSuggestion()}else if(a.keyCode===38){if(this.selectedIndex>=0)this.selectedIndex-=1;this.teaseSuggestion()}else setTimeout(function(){b.trigger("input:changed",b.$("input[name=new_value]").val())},200)},teaseSuggestion:function(){this.$(".available-item");this.$(".available-item.selected").removeClass("selected");this.selectedIndex>=0&&this.selectedIndex<this.$(".available-item").length&&
$(this.$(".available-item")[this.selectedIndex]).addClass("selected")},updateSuggestions:function(a){var b=this;b.$(".available-items").empty();_.each(a,function(c){b.$(".available-items").append($('<div class="available-item"><a href="#" id="'+c._id+'" name="'+c.name+'" value="'+c.name+'">'+c.name+"</a></div>"))});this.selectedIndex=-1},selectAvailableItem:function(a){this.$("input[name=new_value]").val($(a.currentTarget).attr("value"));this.$("input[name=new_value]").focus();return false},newItem:function(){this.selectedIndex>=
0&&this.$("input[name=new_value]").val(this.$(".available-item.selected a").attr("value"));var a=this.$("input[name=new_value]").val();if(!_.include(this._items,a)&&a.length>0){this._items.push(a);this.trigger("changed");this.render();this.$("input[name=new_value]").focus()}else this.trigger("error:alreadyexists");return false},removeItem:function(a){var b=$(a.target).attr("value");this._items=_.reject(this._items,function(c){return c===b});this.trigger("changed");return false},value:function(){return this._items},
render:function(){$(this.el).html(_.renderTemplate("multi_string_editor",{items:this._items}))}});function addEmptyDoc(a,b,c){a=graph.get(a);a=graph.set(Data.uuid("/document/"+app.username+"/"),a.meta.template);a.set({creator:"/user/"+app.username,created_at:new Date,updated_at:new Date,name:b,title:c});return a}
var Document=Backbone.View.extend({events:{"mouseover .content-node":"highlightNode","mouseout .content-node":"unhighlightNode","click .content-node":"selectNode","click .toc-item":"scrollTo","click a.move-node":"moveNode","click a.toggle-move-node":"toggleMoveNode","click a.toggle-comments":"toggleComments","click a.create-comment":"createComment","click a.remove-comment":"removeComment","click a.subscribe-document":"subscribeDocument","click a.unsubscribe-document":"unsubscribeDocument","click a.export-document":"toggleExport",
"click a.toggle-settings":"toggleSettings","click a.toggle-publish-settings":"togglePublishSettings","click a.add_child":"addChild","click a.add_sibling":"addSibling","click a.remove-node":"removeNode"},loadedDocuments:{},togglePublishSettings:function(){$("#document_settings").hide();$(".view-action-icon.settings").removeClass("active");$("#document_export").hide();$(".view-action-icon.export").removeClass("active");this.publishSettings.load();$("#publish_settings").is(":visible")?$(".view-action-icon.publish-settings").removeClass("active"):
$(".view-action-icon.publish-settings").addClass("active");$("#publish_settings").slideToggle();return false},toggleExport:function(){$("#document_settings").hide();$(".view-action-icon.settings").removeClass("active");$("#publish_settings").hide();$(".view-action-icon.publish-settings").removeClass("active");$("#document_export").slideToggle();$(".view-action-icon.export").toggleClass("active");return false},toggleSettings:function(){$("#document_export").hide();$(".view-action-icon.export").removeClass("active");
$("#publish_settings").hide();$(".view-action-icon.publish-settings").removeClass("active");this.settings.load();$("#document_settings").slideToggle();$(".view-action-icon.settings").toggleClass("active");return false},createComment:function(){var a=this;window.pendingSync=true;graph.set(null,{type:"/type/comment",node:this.selectedNode._id,document:this.model._id,created_at:new Date,version:this.version?"/version/"+this.model._id.split("/")[3]+"/"+this.version:null,creator:"/user/"+app.username,
content:this.commentEditor.content()});graph.sync(function(){window.pendingSync=false;a.enableCommentEditor(null,function(){})});return false},removeComment:function(a){var b=this;a=graph.get($(a.currentTarget).attr("comment"));graph.del(a._id);window.pendingSync=true;graph.sync(function(){window.pendingSync=false;b.enableCommentEditor(null,function(){})});return false},loadComments:function(a,b){graph.fetch({type:"/type/comment",node:a},function(c,d){b(d.sort(function(e,f){var g=e.value.get("created_at"),
i=f.value.get("created_at");return g===i?0:g<i?-1:1}))});return false},enableCommentEditor:function(a,b){a=a?a:this.selectedNode;var c=this;this.loadComments(a._id,function(d){var e=$("#"+a.html_id+" > .comments-wrapper");if(e.length!==0){e.html(_.tpl("comments",{doc:c.model,node:a,comments:d}));d=d&&d.length>0?d.length:"";$("#"+a.html_id+" > .operations a.toggle-comments span").html(d);var f=$("#"+a.html_id+" > .comments-wrapper .comment-content");f.unbind();f.click(function(){c.commentEditor=new Proper;
c.commentEditor.activate(f,{multiline:true,markup:true,placeholder:"Enter Comment"});return false});b()}})},toggleComments:function(a){a=$(a.currentTarget).parent().parent().attr("name");var b=this,c=false;if(!b.selectedNode||b.selectedNode._id!==a){b.selectedNode=graph.get(a);b.trigger("select:node",b.selectedNode);c=true}b.enableCommentEditor(null,function(){var d=$("#"+b.selectedNode.html_id+" > .comments-wrapper");d.toggleClass("expanded");c&&d.addClass("expanded");if(d.hasClass("expanded")){d=
d.offset();$("html, body").animate({scrollTop:d.top-100},"slow")}});return false},toggleMoveNode:function(){var a=this;$("#document").addClass("move-mode");$(".move-node").hide();var b=$(".content-node .controls");b.find(".placeholder.move").show();b.each(function(){function c(k){if(k.get("children")){var n=false;k.get("children").each(function(o){if(o.type.key==="/type/section"){n||(h+=1);n=true;c(o)}})}}function d(k){if(k===f)j=true;else(k=a.getParent(k))&&d(k);return j}var e=$(this),f=a.selectedNode,
g=a.selectedNode.type.key=="/type/section"?"container-node":"leaf-node",i=0,h=0;c(f);var j=false;e.find(".move-node."+g).each(function(){var k=$(this).hasClass("child")?"child":"sibling",n=parseInt($(this).attr("level")),o=graph.get($(this).attr("node")),m=a.getParent(o);j=false;if(!d(o))if(k==="sibling"){k=m.properties().get("children").expectedTypes;if(_.include(k,a.selectedNode.type.key))if(f.type.key!=="/type/section"?true:n+h<=3){$(this).show();i++}}else{$(this).show();i++}});i===0&&e.find(".placeholder.move").hide();
$(".content-node.selected .controls .move-node").hide();b=$(".content-node .controls")});return false},getParent:function(a){if(!a)return null;return graph.get($("#"+a._id.replace(/\//g,"_")).attr("parent"))},initialize:function(){var a=this;this.attributes=new Attributes({model:this.model});this.settings=new DocumentSettings;this.publishSettings=new PublishSettings;this.app=this.options.app;this.mode="show";this.bind("status:changed",function(){a.updateCursors()});this.bind("changed",function(){document.title=
a.model.get("title")||"Untitled";a.app.browser.render()})},moveNode:function(a){var b=this.selectedNode,c=this.getParent(b),d=graph.get($(a.currentTarget).attr("node")),e=this.getParent(d),f=$(a.currentTarget).attr("destination");a=$(a.currentTarget).hasClass("child")?"child":"sibling";c.all("children").del(b._id);c._dirty=true;this.trigger("change:node",c);if(a==="child"){d.all("children").set(b._id,b);d._dirty=true;this.trigger("change:node",d)}else{c=e.all("children").index(d._id);if(f==="after")c+=
1;if(b.type.key==="/type/section"){f=e.get("children").rest(c);var g=false;f=f.select(function(h){if(!g&&h.type.key!=="/type/section"){e.all("children").del(h._id);return true}else{g=true;return false}});d=new Data.Hash;for(a=0;a<b.get("children").length&&b.get("children").at(a).type.key!=="/type/section";){var i=b.get("children").at(a);d.set(i._id,i);a+=1}d=d.union(f);d=d.union(b.get("children").rest(a));b.set({children:d.keys()})}e.all("children").set(b._id,b,c);e._dirty=true;graph.trigger("dirty");
this.trigger("change:node",e)}this.selectedNode=b;this.trigger("select:node",this.selectedNode);return false},scrollTo:function(a){var b=$(a.currentTarget).attr("node");app.scrollTo(b);router.navigate($(a.currentTarget).attr("href"));app.toggleTOC();return false},updateCursors:function(){},render:function(){$(this.el).html(_.tpl("document_wrapper",{mode:this.mode,doc:this.model}));this.renderMenu();if(this.model){this.attributes.render();this.renderDocument()}},renderNode:function(a){var b=$("#"+
a.html_id),c=graph.get(b.attr("parent"));b=parseInt(b.attr("level"));_.include(a.types().keys(),"/type/document")?$("#document").html((new HTMLRenderer(a,c,b)).render()):$("#"+a.html_id).replaceWith((new HTMLRenderer(a,c,b)).render());this.mode==="edit"?renderControls(this.model,null,null,null,0):hijs("#"+a.html_id+" .content-node.code pre")},renderDocument:function(){this.$("#document").html((new HTMLRenderer(this.model,null,0)).render());this.$("#attributes").show();this.$("#document").show();this.mode===
"edit"?renderControls(this.model,null,null,null,0):hijs(".content-node.code pre")},documentTypes:function(){var a=[];graph.get("/config/substance").get("document_types").each(function(b,c){a.push({type:c,name:graph.get(c).name})});return a},renderMenu:function(){if(this.model){$("#document_tab").show();$("#document_tab").html(_.tpl("document_tab",{username:this.model.get("creator")._id.split("/")[2],document_name:this.model.get("name")}))}},init:function(){var a=this;this.unbind("select:node");this.bind("select:node",
function(b){a.resetSelection();$("#"+b.html_id).addClass("selected");$("#document").addClass("edit-mode");editor.deactivate();a.renderNodeEditor(b)});this.bind("change:node",function(b){a.renderNode(b)});a.selectedNode=null;$(document).unbind("keyup");$(document).keyup(function(b){b.keyCode==27&&a.reset();b.stopPropagation()});$(document).bind("keydown","alt+down",function(){if(a.selectedNode){var b=$(".controls[node="+a.selectedNode._id+"][destination=after]");if(b){b.addClass("active");$("#document").addClass("insert-mode")}}});
$(document).bind("keydown","right",function(){});$(document).bind("keydown","left",function(){})},newDocument:function(a,b,c){this.model=addEmptyDoc(a,b,c);this.status=null;this.mode="edit";this.authorized=true;$(this.el).show();this.render();this.loadedDocuments[app.username+"/"+b]=this.model._id;this.init();app.browser&&app.browser.query&&app.browser.query.type==="user"&&app.browser.query.value===app.username&&app.browser.graph.set("nodes",this.model._id,this.model);app.toggleView("document");router.navigate(this.app.username+
"/"+b);$("#document_wrapper").attr("url","#"+this.app.username+"/"+b);this.trigger("changed");notifier.notify(Notifications.BLANK_DOCUMENT);return false},loadDocument:function(a,b,c,d,e,f){function g(j){h.model=graph.get(j);if(h.mode==="edit"&&!(head.browser.webkit||head.browser.mozilla)){alert("Your browser is not yet supported. We recommend Google Chrome and Safari, but you can also use Firefox.");h.mode="show"}if(h.model){h.render();h.init();h.reset();h.trigger("changed");h.loadedDocuments[a+"/"+
b]=j;app.browser.graph.set("nodes",j,h.model);app.toggleView("document");d&&!e&&app.scrollTo(d);if(d&&e){j=graph.get(d.replace(/_/g,"/"));h.selectedNode=j;h.trigger("select:node",h.selectedNode);h.enableCommentEditor(j,function(){$("#"+d+" > .comments-wrapper").show();graph.get(e.replace(/_/g,"/"))?app.scrollTo(e):app.scrollTo("comments"+d)})}}else $("#document_wrapper").html("Document loading failed")}function i(j){if(j==="not_authorized"){$("#document_tab").html("&nbsp;&nbsp;&nbsp; Not Authorized");
$("#document_wrapper").html('<div class="notification error">You are not authorized to access this document.</div>')}else{$("#document_tab").html("&nbsp;&nbsp;&nbsp; Document not found");$("#document_wrapper").html('<div class="notification error">The requested document couldn\'t be found.</div>')}app.toggleView("document")}var h=this;$("#tabs").show();$("#document_tab").show();$("#document_tab").html("&nbsp;&nbsp;&nbsp;Loading...");$.ajax({type:"GET",url:c?"/documents/"+a+"/"+b+"/"+c:"/documents/"+
a+"/"+b,dataType:"json",success:function(j){h.version=j.version;h.authorized=j.authorized;h.published=j.published;h.mode=f||(j.authorized&&!c?"edit":"show");if(j.status==="error")i(j.error);else{graph.merge(j.graph);g(j.id)}},error:function(j){i(JSON.parse(j.responseText).error)}})},subscribeDocument:function(){if(!app.username){alert("Please log in to make a subscription.");return false}graph.set(null,{type:"/type/subscription",user:"/user/"+app.username,document:this.model._id});this.model.set({subscribed:true,
subscribers:this.model.get("subscribers")+1});this.model._dirty=false;this.render();return false},unsubscribeDocument:function(){var a=this;graph.fetch({type:"/type/subscription",user:"/user/"+app.username,document:this.model._id},function(b,c){if(c.length!==0){graph.del(c.first()._id);a.model.set({subscribed:false,subscribers:a.model.get("subscribers")-1});a.model._dirty=false;a.render()}});return false},closeDocument:function(){this.model=null;router.navigate(this.app.username);$("#document_wrapper").attr("url",
"#"+this.app.username);$("#document_tab").hide();app.toggleView("content");this.render()},deleteDocument:function(a){graph.del(a);app.browser.graph.del(a);app.browser.render();$("#document_tab").hide();setTimeout(function(){app.toggleView("browser")},300);notifier.notify(Notifications.DOCUMENT_DELETED)},reset:function(a){if(this.model){a||$(document.activeElement).blur();this.app.document.selectedNode=null;this.resetSelection();return false}},resetSelection:function(){this.$(".content-node.selected").removeClass("selected");
$("#document .controls.active").removeClass("active");$("#document").removeClass("edit-mode");$("#document").removeClass("insert-mode");$(".proper-commands").hide();$(".node-editor-placeholder").html("");$(".move-node").hide();$("#document").removeClass("move-mode")},renderNodeEditor:function(a){a=$("#"+a.html_id);if(this.mode==="edit")if(_.include(this.selectedNode.types().keys(),"/type/document"))this.nodeEditor=new DocumentEditor({el:$("#drawer_content")});else if(this.selectedNode.type._id===
"/type/text")this.nodeEditor=new TextEditor({el:a});else if(this.selectedNode.type._id==="/type/section")this.nodeEditor=new SectionEditor({el:a});else if(this.selectedNode.type._id==="/type/image")this.nodeEditor=new ImageEditor({el:a});else if(this.selectedNode.type._id==="/type/resource")this.nodeEditor=new ResourceEditor({el:a});else if(this.selectedNode.type._id==="/type/quote")this.nodeEditor=new QuoteEditor({el:a});else if(this.selectedNode.type._id==="/type/code")this.nodeEditor=new CodeEditor({el:a});
else if(this.selectedNode.type._id==="/type/question")this.nodeEditor=new QuestionEditor({el:a});else if(this.selectedNode.type._id==="/type/answer")this.nodeEditor=new AnswerEditor({el:a})},updateNode:function(a,b){var c=graph.get(a);c.set(b);this.trigger("change:node",c)},updateSelectedNode:function(a){if(this.selectedNode){this.selectedNode.set(a);this.model.set({updated_at:new Date});a._dirty&&this.trigger("change:node",this.selectedNode);this.selectedNode.type.key==="/type/document"&&this.trigger("changed");
this.status&&this.status.collaborators.length>1&&delete this.selectedNode.toJSON().children}},highlightNode:function(a){$(a.currentTarget).addClass("active");return false},unhighlightNode:function(a){$(a.currentTarget).removeClass("active");return false},selectNode:function(a){var b=$(a.currentTarget).attr("name");if(!a.stopProp&&(!this.selectedNode||this.selectedNode.key!==b)){this.selectedNode=graph.get(b);this.trigger("select:node",this.selectedNode);a.stopProp=true;$("#"+this.selectedNode.html_id+
" > .comments-wrapper").removeClass("expanded")}a.stopPropagation()},updateName:function(a){this.model.set({name:a})},addChild:function(a){if(arguments.length===1){var b=$(a.currentTarget).attr("type"),c=graph.get($(a.currentTarget).attr("node"));b=graph.set(null,{type:b,document:this.model._id})}else{c=graph.get(arguments[1]);b=graph.set(arguments[0].nodeId,arguments[0])}c.all("children").set(b._id,b);c._dirty=true;this.trigger("change:node",c);this.selectedNode=b;this.trigger("select:node",this.selectedNode);
return false},addSibling:function(a){if(arguments.length===1)var b=$(a.currentTarget).attr("type"),c=graph.get($(a.currentTarget).attr("node")),d=graph.get($(a.currentTarget).attr("parent")),e=$(a.currentTarget).attr("destination"),f=graph.set(null,{type:b,document:this.model._id});else{c=graph.get(arguments[1]);d=graph.get(arguments[2]);e=arguments[3];f=graph.set(arguments[0].nodeId,arguments[0])}c=d.all("children").index(c._id);if(e==="after")c+=1;if(b==="/type/section"){b=d.get("children").rest(c);
var g=false;b=b.select(function(i){if(!g&&i.type.key!=="/type/section"){d.all("children").del(i._id);return true}else{g=true;return false}});f.set({children:b.keys()})}d.all("children").set(f._id,f,c);d._dirty=true;this.trigger("change:node",d);this.selectedNode=f;this.trigger("select:node",this.selectedNode);return false},removeNode:function(a){if(arguments.length===1)var b=graph.get($(a.currentTarget).attr("node")),c=graph.get($(a.currentTarget).attr("parent"));else{b=graph.get(arguments[0]);c=
graph.get(arguments[1])}c.all("children").del(b._id);graph.del(b._id);c._dirty=true;this.trigger("change:node",c);this.reset();return false}}),DocumentSettings=Backbone.View.extend({events:{"submit form":"invite","change select.change-mode":"changeMode","click a.remove-collaborator":"removeCollaborator"},changeMode:function(a){var b=$(a.currentTarget).attr("collaborator");a=$(a.currentTarget).val();var c=this;window.pendingSync=true;graph.get(b).set({mode:a});graph.sync(function(){window.pendingSync=
false;c.render()});return false},removeCollaborator:function(a){var b=$(a.currentTarget).attr("collaborator"),c=this;window.pendingSync=true;graph.del(b);graph.sync(function(){window.pendingSync=false;c.collaborators.del(b);c.render()});return false},invite:function(){var a=this;$.ajax({type:"POST",url:"/invite",data:{email:$("#collaborator_email").val(),document:app.document.model._id,mode:$("#collaborator_mode").val()},dataType:"json",success:function(b){if(b.error)return alert(b.error);a.load()},
error:function(){alert("Unknown error occurred")}});return false},load:function(){var a=this;graph.fetch({type:"/type/collaborator",document:app.document.model._id},function(b,c){a.collaborators=c;a.render()})},initialize:function(){this.el="#document_settings"},render:function(){$(this.el).html(_.tpl("document_settings",{collaborators:this.collaborators,document:app.document.model}));this.delegateEvents()}}),PublishSettings=Backbone.View.extend({events:{"click a.publish-document":"publishDocument",
"click .remove-version":"removeVersion","focus #version_remark":"focusRemark","blur #version_remark":"blurRemark"},focusRemark:function(){var a=$("#version_remark");a.val()==="Enter optional remark."&&a.val("")},blurRemark:function(){var a=$("#version_remark");a.val()===""&&a.val("Enter optional remark.")},publishDocument:function(){var a=this,b=$("#version_remark").val();$.ajax({type:"POST",url:"/publish",data:{document:app.document.model._id,remark:b==="Enter optional remark."?"":b},dataType:"json",
success:function(c){if(c.error)return alert(c.error);a.load();app.document.published=true;app.document.render();$("#publish_settings").show()},error:function(c){console.log(c);alert("Unknown error occurred")}});return false},removeVersion:function(a){a=$(a.currentTarget).attr("version");var b=this;window.pendingSync=true;graph.del(a);graph.sync(function(){window.pendingSync=false;b.load();if(b.versions.length===1){app.document.published=false;app.document.render();$("#publish_settings").show()}});
return false},load:function(){var a=this;graph.fetch({type:"/type/version",document:app.document.model._id},function(b,c){a.versions=c.sort(function(d,e){var f=d.value.get("created_at"),g=e.value.get("created_at");return f===g?0:f<g?-1:1});a.render()})},initialize:function(){this.el="#publish_settings"},render:function(){$(this.el).html(_.tpl("publish_settings",{versions:this.versions,document:app.document.model}));this.delegateEvents()}}),ConfirmCollaboration=Backbone.View.extend({events:{"click a.option-tab":"selectOption",
"submit #login-form":"login","submit #signup-form":"register","submit #confirm-form":"doConfirm"},initialize:function(a){var b=this;this.el="#content_wrapper";this.tan=a;graph.fetch({type:"/type/collaborator",tan:this.tan,document:{}},function(c,d){b.document=d.select(function(e){return e.types().get("/type/document")}).first();b.collaborator=d.select(function(e){return e.types().get("/type/collaborator")}).first();b.render()})},selectOption:function(a){a=$(a.currentTarget).attr("option");this.$(".option").removeClass("active");
this.$(".option-tab").removeClass("active");this.$(".option."+a).addClass("active");this.$(".option-tab."+a).addClass("active");return false},doConfirm:function(){var a=this;this.confirm(function(b){if(b)return alert("Collaboration could not be confirmed. "+b.error);window.location.href="/"+a.document.get("creator")._id.split("/")[2]+"/"+a.document.get("name")});return false},confirm:function(a){$.ajax({type:"POST",url:"/confirm_collaborator",data:{tan:this.tan,user:app.username},dataType:"json",
success:function(b){if(b.error)return a({error:b.error});a(null)},error:function(){a({error:"Error occurred"})}})},login:function(){var a=this;app.authenticate(this.$(".username").val(),this.$(".password").val(),function(b){if(b)return notifier.notify(Notifications.AUTHENTICATION_FAILED);a.confirm(function(c){if(c)return alert("Collaboration could not be confirmed. "+c.error);window.location.href="/"+a.document.get("creator")._id.split("/")[2]+"/"+a.document.get("name")})});return false},register:function(){var a=
this;$(".page-content .input-message").empty();$("#registration_error_message").empty();$(".page-content input").removeClass("error");app.createUser($("#signup_user").val(),$("#signup_name").val(),$("#signup_email").val(),$("#signup_password").val(),function(b,c){if(b)if(c.field==="username"){$("#signup_user").addClass("error");$("#signup_user_message").html(c.message)}else $("#registration_error_message").html(c.message);else{graph.merge(c.seed);notifier.notify(Notifications.AUTHENTICATED);app.username=
c.username;a.trigger("authenticated");app.render();a.confirm(function(d){if(d)return alert("Collaboration could not be confirmed. "+d.error);window.location.href="/"+a.document.get("creator")._id.split("/")[2]+"/"+a.document.get("name")})}});return false},render:function(){var a=this.collaborator.get("user");if(a&&a._id==="/user/"+app.username)window.location.href="/"+this.document.get("creator")._id.split("/")[2]+"/"+this.document.get("name");else{$(this.el).html(_.tpl("confirm_collaboration",{collaborator:this.collaborator,
document:this.document}));this.delegateEvents()}}}),RecoverPassword=Backbone.View.extend({events:{"submit form":"requestReset"},requestReset:function(){$.ajax({type:"POST",url:"/recover_password",data:{username:$("#username").val()},dataType:"json",success:function(a){if(a.error)return $("#registration_error_message").html("Username does not exist.");$(".recover").hide();$(".success").show()},error:function(){$("#registration_error_message").html("Username does not exist.")}});return false},initialize:function(){this.el=
"#content_wrapper";this.render()},render:function(){$(this.el).html(_.tpl("recover_password",{}));this.delegateEvents()}}),ResetPassword=Backbone.View.extend({events:{"submit form":"resetPassword"},resetPassword:function(){if($("#password").val()!==$("#password_confirmation").val())return alert("Password and confirmation do not match!");var a=this;$.ajax({type:"POST",url:"/reset_password",data:{username:a.username,tan:a.tan,password:$("#password").val()},dataType:"json",success:function(b){if(b.status===
"error")return $("#registration_error_message").html(b.message);window.location.href="/"+a.username},error:function(){$("#registration_error_message").html("Unknown error.")}});return false},initialize:function(a,b){this.username=a;this.tan=b;this.el="#content_wrapper";this.render()},render:function(){$(this.el).html(_.tpl("reset_password",{}));this.delegateEvents()}}),Attributes=Backbone.View.extend({initialize:function(){this.el="#attributes"},render:function(){app.document.mode==="edit"?this.renderEdit():
this.renderShow()},renderShow:function(){var a=app.document.model,b=[];b=a.properties().select(function(c){if(c.expectedTypes[0]==="/type/attribute")return true});$(this.el).html(_.tpl("show_attributes",{attributes:b,doc:a}))},availableAttributes:function(a){return graph.find({"type|=":["/type/attribute"],member_of:"/"+a.type._id.split("/")[2]+"/"+a.key})},renderEdit:function(){var a=this,b=app.document.model,c=[];c=b.properties().select(function(d){if(d.expectedTypes[0]==="/type/attribute")return true});
$(this.el).html(_.tpl("edit_attributes",{attributes:c,doc:b}));$(".attribute-editor").each(function(){var d=$(this).attr("property");graph.get("/type/"+d.split("/")[1]).get("properties",d.split("/")[2]);var e=$(this).attr("key"),f=$(this).hasClass("unique"),g=$(this).attr("type");value=f?app.document.model.get(e).get("name"):_.map(app.document.model.get(e).values(),function(h){return h.get("name")});var i=a.createAttributeEditor(e,g,f,value,$(this));i.bind("input:changed",function(h){if(h.length<
2)return i.updateSuggestions({});$.ajax({type:"GET",data:{member:d,search_str:h},url:"/attributes",dataType:"json"}).success(function(j){graph.merge(j.graph);i.updateSuggestions(j.graph)})});i.bind("changed",function(){var h=[];_.each(i.value(),function(k){var n=graph.find({"type|=":["/type/attribute"],member_of:d,name:k}).first();n||(n=graph.set(null,{type:["/type/attribute"],member_of:d,name:k}));h.push(n._id)});var j={};j[e]=h;app.document.model.set(j);app.document.trigger("changed")})})},createAttributeEditor:function(a,
b,c,d,e){switch(b){case "string":return c?this.createStringEditor(a,d,e):this.createMultiStringEditor(a,d,e);case "number":break;case "boolean":break}},createMultiStringEditor:function(a,b,c){return new UI.MultiStringEditor({el:c,items:b})},createStringEditor:function(a,b,c){return new UI.StringEditor({el:c,value:b})}}),AddCriterion=function(a,b){this.app=a;this.options=b};
AddCriterion.prototype.matchesInverse=function(a){return a instanceof RemoveCriterion&&this.options.property===a.options.property&&this.options.operator==="CONTAINS"&&a.options.operator==="CONTAINS"&&this.options.value===a.options.value};AddCriterion.prototype.matchesOverride=function(){};
AddCriterion.prototype.execute=function(){this.graph=app.browser.graph;var a=new Data.Criterion(this.options.operator,"/type/document",this.options.property,this.options.value);app.browser.graph=app.browser.graph.filter(a);this.app.facets.addChoice(this.options.property,this.options.operator,this.options.value)};AddCriterion.prototype.unexecute=function(){app.browser.graph=this.graph;this.app.facets.removeChoice(this.options.property,this.options.operator,this.options.value)};
var RemoveCriterion=function(a,b){this.app=a;this.options=b};RemoveCriterion.prototype.execute=function(){};RemoveCriterion.prototype.unexecute=function(){};
var DocumentBrowser=Backbone.View.extend({events:{"click a.add-criterion":"addCriterion","click a.remove-criterion":"removeCriterion"},addCriterion:function(a){var b=$(a.currentTarget).attr("property"),c=$(a.currentTarget).attr("operator");a=$(a.currentTarget).attr("value");this.applyCommand({command:"add_criterion",options:{property:b,operator:c,value:a}});this.render();return false},removeCriterion:function(a){var b=$(a.currentTarget).attr("property"),c=$(a.currentTarget).attr("operator");a=$(a.currentTarget).attr("value");
this.applyCommand({command:"remove_criterion",options:{property:b,operator:c,value:a}});this.render();return false},initialize:function(a){this.app=a.app;this.browserTab=new BrowserTab({el:"#browser_tab",browser:this});this.documents=[];this.commands=[];this.graph=new Data.Graph(seed)},load:function(a){var b=this;this.query=a;$("#browser_tab").show().html("&nbsp;&nbsp;&nbsp;Loading documents...");$("#browser_wrapper").html("");$.ajax({type:"GET",url:"/documents/search/"+a.type+"/"+encodeURI(a.value),
dataType:"json",success:function(c){b.graph=new Data.Graph(seed);b.graph.merge(c.graph);b.facets=new Facets({browser:b});b.loaded=true;b.trigger("loaded");b.render()},error:function(){}})},render:function(){if(this.loaded){this.documents=this.graph.find({"type|=":"/type/document"});this.documents=this.documents.sort(function(a,b){var c=a.value.get("updated_at"),d=b.value.get("updated_at");return c===d?0:c>d?-1:1});$(this.el).html(_.tpl("document_browser",{documents:this.documents,user:this.query.type===
"user"?this.graph.get("/user/"+this.query.value):null,query:this.query}));this.loaded&&this.facets.render();this.browserTab.render()}},applyCommand:function(a){var b;if(a.command==="add_criterion")b=new AddCriterion(this,a.options);else if(a.command==="remove_criterion")b=new RemoveCriterion(this,a.options);this.currentCommand<this.commands.length-1&&this.commands.splice(this.currentCommand+1);var c=undefined;$.each(this.commands,function(d,e){if(e.matchesInverse(b))c=d});if(c>=0){this.commands[c].unexecute();
this.commands.splice(c,1);for(a=c;a<this.commands.length;a++)this.commands[a].execute()}else{this.commands.push(b);b.execute()}this.currentCommand=this.commands.length-1;return b},undo:function(){if(this.currentCommand>=0){this.commands[this.currentCommand].unexecute();this.currentCommand-=1;this.render()}},redo:function(){if(this.currentCommand<this.commands.length-1){this.currentCommand+=1;this.commands[this.currentCommand].execute();this.render()}}}),Facets=Backbone.View.extend({initialize:function(a){this.browser=
a.browser;this.facetChoices={};this.el="#facets"},select:function(a){$(".facet").removeClass("selected");$("#facet_"+a).toggleClass("selected")},addChoice:function(a,b,c){this.facetChoices[a+"::"+b+"::"+c]=true},removeChoice:function(a,b,c){delete this.facetChoices[a+"::"+b+"::"+c]},buildView:function(){var a=this,b={facets:[]},c=new Data.Hash;app.browser.graph.get("/config/substance").get("document_types").each(function(d){c=c.union(app.browser.graph.get(d).properties())});app.browser.graph.get("/type/document").all("properties").each(function(d,
e){if(d.meta.facet){var f=[],g=[];d.all("values").each(function(i){a.facetChoices[e+"::CONTAINS::"+i._id]===true?g.push({key:escape(i._id),value:i.toString(),item_count:i.referencedObjects.length}):f.push({key:escape(i._id),value:i.toString(),item_count:i.referencedObjects.length})});f.length+g.length>0&&b.facets.push({property:e,property_name:d.name,facet_choices:f,selected_facet_choices:g})}});return b},render:function(){$(this.el).html(_.renderTemplate("facets",this.buildView()))}}),Collaborators=
Backbone.View.extend({initialize:function(){this.render()},render:function(){$(this.el).html(Helpers.renderTemplate("collaborators",{status:app.editor.status,id:app.editor.model.id,author:app.editor.model.author,name:app.editor.model.name,hostname:window.location.hostname+(window.location.port!==80?":"+window.location.port:"")}))}}),UserSettings=Backbone.View.extend({events:{"submit form":"updateUser"},updateUser:function(){this.$("#user_password").val()===""||this.$("#user_password").val()===this.$("#user_password_confirmation").val()?
$.ajax({type:"POST",url:"/updateuser",data:{username:this.$("#user_username").val(),name:this.$("#user_name").val(),email:this.$("#user_email").val(),password:this.$("#user_password").val(),website:this.$("#user_website").val(),company:this.$("#user_company").val(),location:this.$("#user_location").val()},dataType:"json",success:function(a){if(a.status==="error")notifier.notify({message:"An error occured. Check your input",type:"error"});else{graph.merge(a.seed);app.username=a.username;app.render();
app.document.closeDocument();app.browser.load(app.query());app.browser.bind("loaded",function(){app.toggleView("browser")});router.navigate(app.username)}},error:function(){notifier.notify({message:"An error occured. Check your input",type:"error"})}}):notifier.notify({message:"Password and confirmation do not match.",type:"error"});return false},initialize:function(){},render:function(){$(this.el).html(_.tpl("user_settings",{user:graph.get("/user/"+app.username)}))}}),NewDocument=Backbone.View.extend({initialize:function(){},
render:function(){$(this.el).html(_.tpl("new_document",{}))}}),BrowserTab=Backbone.View.extend({events:{"submit #search_form":"loadDocuments","keydown #search":"search","focus #search":"focusSearch","blur #search":"blurSearch"},focusSearch:function(a){this.searchValue=$(a.currentTarget).val();this.active=true;$(a.currentTarget).val("")},blurSearch:function(){var a=this;this.active=false;setTimeout(function(){a.render()},200)},search:function(a){if(a.keyCode===27)return this.blurSearch();var b=this;
if($("#search").val()!=="")if(!b.pendingSearch){b.pendingSearch=true;setTimeout(function(){b.pendingSearch=false;b.active&&$("#search").val()!==""&&$.ajax({type:"GET",url:"/quicksearch/"+encodeURI($("#search").val()),dataType:"json",success:function(c){b.$(".results").html("");b.$(".results").append($('<a href="/search/'+encodeURI($("#search").val())+'" class="result-item documents">'+c.document_count+" Documents / "+_.keys(c.users).length+" Users</a>"));_.each(c.users,function(d){b.$(".results").append($('<a href="/'+
d.username+'" class="result-item user"><div class="username">'+d.username+'</div><div class="full-name">'+(d.name?d.name:"")+'</div><div class="count">User</div></a>'))});$("#browser_tab .results").show()},error:function(){}})},500)}},loadDocuments:function(){app.searchDocs($("#search").val());return this.active=false},loadUser:function(){},initialize:function(a){this.browser=a.browser},render:function(){var a;if(this.browser.query)switch(this.browser.query.type){case "user":a=this.browser.query.value+
"'s documents";break;case "recent":a="Recent Documents";break;case "subscribed":a="Subscribed Documents";break;default:a="Documents for &quot;"+this.browser.query.value+"&quot;"}else a="Type to search ...";$(this.el).html(_.tpl("browser_tab",{documents:this.browser.documents,query_descr:a,query:this.browser.query}))}}),Header=Backbone.View.extend({events:{"focus #login-user":"focusUser","blur #login-user":"blurUser","focus #login-password":"focusPassword","blur #login-password":"blurPassword"},initialize:function(){},
focusUser:function(a){a=$(a.currentTarget);if(a.hasClass("hint")){a.val("");a.removeClass("hint")}},blurUser:function(a){a=$(a.currentTarget);if(a.val()===""){a.addClass("hint");a.val("Username")}},focusPassword:function(a){a=$(a.currentTarget);if(a.hasClass("hint")){a.val("");a.removeClass("hint")}},blurPassword:function(a){a=$(a.currentTarget);if(a.val()===""){a.addClass("hint");a.val("Password")}},render:function(){var a=this.options.app.username,b=graph.find({"type|=":"/type/notification",recipient:"/user/"+
a});b=b.sort(function(c,d){c=c.value.get("created_at");d=d.value.get("created_at");return c===d?0:c>d?-1:1});$(this.el).html(_.tpl("header",{user:graph.get("/user/"+a),notifications:b,count:b.select(function(c){return!c.get("read")}).length,notifications_active:this.notificationsActive}))}}),Router=Backbone.Router.extend({initialize:function(){this.route(":username","user",app.userDocs);this.route(":username/:docname/:p1/:p2/:p3","node",this.loadDocument);this.route(":username/:docname/:p1/:p2","node",
this.loadDocument);this.route(":username/:docname/:p1","node",this.loadDocument);this.route(":username/:docname","node",this.loadDocument);this.route("reset/:username/:tan","reset",this.resetPassword);this.route("subscribed","subscribed",app.subscribedDocs);this.route("recent","recent",app.recentDocs);this.route("collaborate/:tan","collaborate",this.collaborate);this.route("search/:searchstr","search",app.searchDocs);this.route("register","register",app.toggleSignup);this.route("recover","recover",
this.recoverPassword);this.route("","startpage",app.toggleStartpage)},collaborate:function(a){$("#content_wrapper").attr("url","collaborate/"+a);new ConfirmCollaboration(a);app.toggleView("content");$("#header").hide();$("#tabs").hide();$("#footer").hide();return false},recoverPassword:function(){$("#content_wrapper").attr("url","recover");new RecoverPassword;app.toggleView("content");$("#header").hide();$("#tabs").hide();$("#footer").hide();return false},resetPassword:function(a,b){$("#content_wrapper").attr("url",
"reset/"+a+"/"+b);new ResetPassword(a,b);app.toggleView("content");$("#header").hide();$("#tabs").hide();$("#footer").hide();return false},loadDocument:function(a,b,c,d,e){var f=!c||c.indexOf("_")>=0?null:c,g=f?d:c,i=f?e:d;app.browser.load({type:"user",value:a});app.document.loadDocument(a,b,f,g,i);$("#document_wrapper").attr("url",a+"/"+b+(c?"/"+c:"")+(d?"/"+d:"")+(e?"/"+e:""));$("#browser_wrapper").attr("url",a);return false}}),Application=Backbone.View.extend({events:{"click .new-document":"newDocument",
"click a.load-document":"loadDocument","click a.signup":"toggleSignup","click .tab":"switchTab","click a.show-attributes":"showAttributes","submit #create_document":"createDocument","submit #login-form":"login","click a.delete-document":"deleteDocument","click a.toggle-signup":"toggleSignup","click a.toggle-startpage":"toggleStartpage","click a.toggle-edit-mode":"toggleEditMode","click a.toggle-show-mode":"toggleShowMode","click .toggle.logout":"logout","click .toggle.user-settings":"toggleUserSettings",
"click .toggle.user-profile":"toggleUserProfile","submit #signup-form":"registerUser","click .toggle.notifications":"toggleNotifications","click .toggle-toc":"toggleTOC","click #event_notifications a .notification":"hideNotifications","click #toc_wrapper":"toggleTOC","click a.open-notification":"openNotification","change #document_name":"updateDocumentName","click a.toggle-recent":"toggleRecent","click a.toggle-subscribed":"toggleSubscribed","click a.toggle-userdocs":"toggleUserDocs"},toggleRecent:function(){this.recentDocs();
return false},toggleSubscribed:function(){this.subscribedDocs();return false},toggleUserDocs:function(){this.userDocs(app.username);return false},userDocs:function(a){app.browser.load({type:"user",value:a});$("#browser_wrapper").attr("url",a);app.browser.bind("loaded",function(){app.toggleView("browser");app.browser.unbind("loaded")});return false},updateDocumentName:function(a){var b=$(a.currentTarget).val();this.checkDocumentName(b,function(c){if(c){app.document.updateName(b);router.navigate(app.username+
"/"+b)}else{$("#document_name").val(app.document.model.get("name"));alert("Sorry, this name is already taken.")}});return false},login:function(){var a=this;this.authenticate($("#login-user").val(),$("#login-password").val(),function(b){if(b)return notifier.notify(Notifications.AUTHENTICATION_FAILED);a.trigger("authenticated")});return false},openNotification:function(a){a=$(a.currentTarget).attr("href");var b=a.replace("#","").split("/"),c=b[0],d=b[1],e=!b[2]||b[2].indexOf("_")>=0?null:b[2];app.document.loadDocument(c,
d,e,e?b[3]:b[2],e?b[4]:b[3]);$("#document_wrapper").attr("url",a);return false},recentDocs:function(){app.browser.load({type:"recent",value:50});$("#browser_wrapper").attr("url","recent");app.browser.bind("loaded",function(){app.toggleView("browser");app.browser.unbind("loaded")});return false},subscribedDocs:function(){app.browser.load({type:"subscribed",value:50});$("#browser_wrapper").attr("url","subscribed");app.browser.bind("loaded",function(){app.toggleView("browser");app.browser.unbind("loaded")});
return false},searchDocs:function(a){app.browser.load({type:"keyword",value:encodeURI(a)});$("#browser_wrapper").attr("url","search/"+encodeURI(a));app.browser.bind("loaded",function(){app.toggleView("browser")})},toggleStartpage:function(){app.browser.browserTab.render();$("#content_wrapper").html(_.tpl("startpage"));$("#slider").nivoSlider({manualAdvance:true});var a=document.createElement("script"),b=document.getElementsByTagName("script")[0];a.type="text/javascript";a.async=true;a.src="http://api.flattr.com/js/0.6/load.js?mode=auto";
b.parentNode.insertBefore(a,b);app.toggleView("content");return false},showNotifications:function(){this.header.notificationsActive=true;this.header.render()},toggleTOC:function(){if($("#toc_wrapper").is(":hidden")){$("#document .board").addClass("active");$("#toc_wrapper").slideDown();$("#toc_wrapper").css("top",Math.max(_.scrollTop()-$("#document").offset().top,0))}else{$("#document .board").removeClass("active");$("#toc_wrapper").slideUp()}return false},hideNotifications:function(){graph.find({"type|=":"/type/notification",
recipient:"/user/"+app.username}).select(function(a){return!a.get("read")}).each(function(a){a.set({read:true})});this.header.notificationsActive=false;this.header.render()},toggleNotifications:function(){$("#event_notifications").hasClass("active")?this.hideNotifications():this.showNotifications();return false},loadNotifications:function(){var a=this;$.ajax({type:"GET",url:"/notifications",dataType:"json",success:function(b){var c={};_.each(b,function(d,e){graph.get(e)||(c[e]=d)});graph.merge(c);
a.header.render()}})},toggleUserProfile:function(){var a=this;app.browser.load({type:"user",value:this.username});app.browser.bind("loaded",function(){app.toggleView("browser");$("#browser_wrapper").attr("url",a.username);app.browser.unbind("loaded")})},newDocument:function(){if(!head.browser.webkit){alert("You need to use a Webkit based browser (Google Chrome, Safari) in order to write documents. In future, other browers will be supported too.");return false}this.content=new NewDocument({el:"#content_wrapper"});
this.content.render();this.toggleView("content");return false},scrollTo:function(a){(a=$("#"+a).offset())&&$("html, body").animate({scrollTop:a.top},"slow");return false},toggleUserSettings:function(){this.content=new UserSettings({el:"#content_wrapper"});this.content.render();this.toggleView("content");return false},toggleSignup:function(){$("#content_wrapper").attr("url","register");app.browser.browserTab.render();$("#content_wrapper").html(_.tpl("signup"));app.toggleView("content");return false},
switchTab:function(a){this.toggleView($(a.currentTarget).attr("view"))},toggleView:function(a){$(".tab").removeClass("active");$("#"+a+"_tab").addClass("active");if(!(a==="browser"&&!this.browser.loaded)){$(".view").hide();$("#"+a+"_wrapper").show();$("#header").show();$("#tabs").show();$("#footer").show();setTimeout(function(){router.navigate($("#"+a+"_wrapper").attr("url"))},10);return false}},checkDocumentName:function(a,b){if(RegExp(graph.get("/type/document").get("properties","name").validator).test(a)){$.ajax({type:"GET",
url:"/documents/"+app.username+"/"+a,dataType:"json",success:function(c){c.status==="error"?b(true):b(false)},error:function(){b(true)}});return false}else b(false)},createDocument:function(){var a=this,b=$("#create_document input[name=new_document_name]").val(),c=_.slug(b);this.checkDocumentName(c,function(d){if(d)a.document.newDocument("/type/article",c,b);else{$("#create_document input[name=new_document_name]").addClass("error");$("#new_document_name_message").html("This document name is already taken.")}});
return false},toggleEditMode:function(){var a=app.document.model.get("creator")._id.split("/")[2],b=app.document.model.get("name");$("#document_wrapper").attr("url",a+"/"+b);app.document.loadDocument(a,b,null,null,null,"edit");return false},toggleShowMode:function(){var a=app.document.model.get("creator")._id.split("/")[2],b=app.document.model.get("name");$("#document_wrapper").attr("url",a+"/"+b);app.document.loadDocument(a,b,null,null,null,"show");return false},loadDocument:function(a){var b=$(a.currentTarget).attr("user").toLowerCase();
name=$(a.currentTarget).attr("name");app.document.loadDocument(b,name,null,null,null);if(router){router.navigate($(a.currentTarget).attr("href"));$("#document_wrapper").attr("url",$(a.currentTarget).attr("href"))}return false},showAttributes:function(){app.document.drawer.toggle("Attributes");$(".show-attributes").toggleClass("selected");return false},logout:function(){$.ajax({type:"POST",url:"/logout",dataType:"json",success:function(){window.location.reload()}});return false},deleteDocument:function(){if(confirm("Are you sure you want to delete this document?")){this.document.deleteDocument(app.document.model._id);
this.document.closeDocument()}return false},updateSystemStatus:function(a){this.activeUsers=a.active_users},query:function(){return this.authenticated?{type:"user",value:this.username}:{type:"user",value:"demo"}},initialize:function(){var a=this;this.browser=new DocumentBrowser({el:this.$("#browser_wrapper"),app:this});this.document=new Document({el:"#document_wrapper",app:this});this.header=new Header({el:"#header",app:this});this.activeUsers=[];$("body").click(function(){app.document.reset(true);
return true});if(session.username){graph.merge(session.seed);this.authenticated=true;this.username=session.username;this.trigger("authenticated");$("#tabs").show();$(".new-document").show()}else this.authenticated=false;this.bind("authenticated",function(){window.location.reload()});setInterval(function(){a.loadNotifications()},3E4);a.render()},getFullDocument:function(a){function b(d){if(!c[d]){var e=graph.get(d);c[d]=e.toJSON();e.type.all("properties").each(function(f){f.isObjectType()&&e.all(f.key).each(function(g){g.type&&
b(g._id)})})}}var c={};b(a);return c},authenticate:function(a,b,c){var d=this;$.ajax({type:"POST",url:"/login",data:{username:a,password:b},dataType:"json",success:function(e){if(e.status==="error")c({error:"authentication_failed"});else{graph.merge(e.seed);d.username=e.username;c(null)}},error:function(){c({error:"authentication_failed"})}});return false},registerUser:function(){var a=this;$(".page-content .input-message").empty();$("#registration_error_message").empty();$(".page-content input").removeClass("error");
this.createUser($("#signup_user").val(),$("#signup_name").val(),$("#signup_email").val(),$("#signup_password").val(),function(b,c){if(b)if(c.field==="username"){$("#signup_user").addClass("error");$("#signup_user_message").html(c.message)}else $("#registration_error_message").html(c.message);else{graph.merge(c.seed);notifier.notify(Notifications.AUTHENTICATED);a.username=c.username;window.location.href="/"+c.username}});return false},createUser:function(a,b,c,d,e){$.ajax({type:"POST",url:"/register",
data:{username:a,name:b,email:c,password:d},dataType:"json",success:function(f){f.status==="error"?e("error",f):e(null,f)},error:function(){alert("Unknown error. Couldn't create user.")}});return false},render:function(){this.document.render();this.browser.render();this.header.render();return this}}),remote,app,router,editor,graph=(new Data.Graph(seed,{dirty:false,syncMode:"push"})).connect("ajax");
(function(){$(function(){if(function(){if(head.browser.mozilla&&head.browser.version>"1.9.2")return true;if(head.browser.webkit&&head.browser.version>"533.0")return true;if(head.browser.opera&&head.browser.version>"11.0")return true;return false}()){$("#container").show();window.positionBoard=function(){if(document.getElementById("document_wrapper").offsetTop-_.scrollTop()<0){$("#document .board").addClass("docked");$("#document .board").css("left",$("#document").offset().left+"px");$("#document .board").css("width",
$("#document").width()+"px");var a=$("#toc_wrapper").offset();a&&_.scrollTop()<a.top&&$("#toc_wrapper").css("top",_.scrollTop()-$("#document").offset().top+"px")}else{$("#document .board").css("left","");$("#toc_wrapper").css("top",0);$("#document .board").removeClass("docked")}};positionBoard();$(window).bind("scroll",positionBoard);$(window).bind("resize",positionBoard);app=new Application({el:$("#container"),session:session});editor=new Proper;router=new Router({app:this});Backbone.history.start({pushState:true});
window.onbeforeunload=function(){if(graph.dirtyNodes().length>0)return"You have unsynced changes, which will be lost."};window.pendingSync=false;graph.bind("dirty",function(){if(!pendingSync){pendingSync=true;setTimeout(function(){$("#sync_state").fadeIn(100);graph.sync(function(a){pendingSync=false;if(a){confirm("There are conflicted or rejected nodes since the last sync. The workspace will be reset for your own safety. Keep in mind we do not yet support simultaneous editing of one document.");window.location.reload(true)}else setTimeout(function(){$("#sync_state").fadeOut(100)},
1500)})},3E3)}})}else{$("#container").html(_.tpl("browser_not_supported"));$("#container").show()}})})();
