var Notifications={CONNECTED:{message:"Just established a server connection.",type:"info"},AUTHENTICATED:{message:"Successfully authenticated.",type:"success"},AUTHENTICATION_FAILED:{message:"Authentication failed.",type:"error"},SIGNUP_FAILED:{message:"User Registration failed. Check your input",type:"error"},DOCUMENT_LOADING:{message:"Loading document ...",type:"info"},DOCUMENT_LOADED:{message:"Document successfully loaded.",type:"success"},DOCUMENT_LOADING_FAILED:{message:"An error ocurred during loading.",
type:"error"},DOCUMENTS_LOADING:{message:"Loading available documents ...",type:"info"},DOCUMENTS_LOADED:{message:"Documents fetched.",type:"success"},DOCUMENTS_LOADING_FAILED:{message:"An error occured during loading documents",type:"error"},BLANK_DOCUMENT:{message:"You are now editing a blank document.",type:"info"},DOCUMENT_SAVING:{message:"Saving document ...",type:"info"},DOCUMENT_SAVED:{message:"The document has been stored in the repository.",type:"success"},DOCUMENT_SAVING_FAILED:{message:"Error during saving.",
type:"error"},SYNCHRONIZING:{message:"Synchronizing with server ...",type:"info"},SYNCHRONIZED:{message:"Successfully synchronized with server",type:"info"},SYNCHRONIZING_FAILED:{message:"Failed to synchronize with server",type:"error"},DOCUMENT_INVALID:{message:"The document is invalid. Make sure that you've set a correct name for it.",type:"error"},DOCUMENT_ALREADY_EXISTS:{message:"This document name is already taken.",type:"error"},DOCUMENT_DELETING:{message:"Deleting document ...",type:"info"},
DOCUMENT_DELETED:{message:"The document has been deleted.",type:"success"},DOCUMENT_DELETING_FAILED:{message:"Error during deletion.",type:"error"},NEW_COLLABORATOR:{message:"A new collaborator just went online.",type:"info"},EXIT_COLLABORATOR:{message:"One collaborator just left.",type:"info"}};Backbone.Notifier=function(a){a||(a={});this.initialize&&this.initialize(a)};_.extend(Backbone.Notifier.prototype,Backbone.Events,{notify:function(a){this.trigger("message:arrived",a)}});var notifier=new Backbone.Notifier;
notifier.bind("message:arrived",function(a){var b=$('<p class="notification"><span>info:</span>'+a.message+"</p>");$("#notifications .wrapper").append(b);if(a.message.indexOf("...")!==-1)b.addClass("activity");else{$("#notifications .wrapper p.activity").remove();setTimeout(function(){b.remove()},4E3)}});
(function(){_.date=function(a){var b=Date.parse(a),c=0,d;if(isNaN(b)&&(d=/^(\d{4}|[+\-]\d{6})-(\d{2})-(\d{2})(?:[T ](\d{2}):(\d{2})(?::(\d{2})(?:\.(\d{3,}))?)?(?:(Z)|([+\-])(\d{2})(?::?(\d{2}))?))?/.exec(a))){if(d[8]!=="Z"){c=+d[10]*60+ +d[11];if(d[9]==="+")c=0-c}b=Date.UTC(+d[1],+d[2]-1,+d[3],+d[4],+d[5]+c,+d[6],+d[7].substr(0,3))}return(new Date(b)).toDateString()}})();if(!window.console)window.console={log:function(){}};var Helpers={};
Helpers.renderTemplate=_.renderTemplate=function(a,b,c){source=$("script[name="+a+"]").html();return Handlebars.compile(source)(b,c||{})};_.tpl=function(a,b){source=$("script[name="+a+"]").html();return _.template(source,b)};
_.gravatar=function(a,b){b=b||80;return"http://www.gravatar.com/avatar/"+function(c){function d(o,n){var q,p,t,s,r;t=o&2147483648;s=n&2147483648;q=o&1073741824;p=n&1073741824;r=(o&1073741823)+(n&1073741823);if(q&p)return r^2147483648^t^s;return q|p?r&1073741824?r^3221225472^t^s:r^1073741824^t^s:r^t^s}function j(o,n,q,p,t,s,r){o=d(o,d(d(n&q|~n&p,t),r));return d(o<<s|o>>>32-s,n)}function k(o,n,q,p,t,s,r){o=d(o,d(d(n&p|q&~p,t),r));return d(o<<s|o>>>32-s,n)}function l(o,n,q,p,t,s,r){o=d(o,d(d(n^q^p,t),
r));return d(o<<s|o>>>32-s,n)}function m(o,n,q,p,t,s,r){o=d(o,d(d(q^(n|~p),t),r));return d(o<<s|o>>>32-s,n)}function u(o){var n="",q="",p;for(p=0;p<=3;p++){q=o>>>p*8&255;q="0"+q.toString(16);n+=q.substr(q.length-2,2)}return n}var i=[],v,w,y,x,e,f,g,h;c=function(o){o=o.replace(/\r\n/g,"\n");for(var n="",q=0;q<o.length;q++){var p=o.charCodeAt(q);if(p<128)n+=String.fromCharCode(p);else{if(p>127&&p<2048)n+=String.fromCharCode(p>>6|192);else{n+=String.fromCharCode(p>>12|224);n+=String.fromCharCode(p>>
6&63|128)}n+=String.fromCharCode(p&63|128)}}return n}(c);i=function(o){var n,q=o.length;n=q+8;for(var p=((n-n%64)/64+1)*16,t=Array(p-1),s=0,r=0;r<q;){n=(r-r%4)/4;s=r%4*8;t[n]|=o.charCodeAt(r)<<s;r++}n=(r-r%4)/4;s=r%4*8;t[n]|=128<<s;t[p-2]=q<<3;t[p-1]=q>>>29;return t}(c);e=1732584193;f=4023233417;g=2562383102;h=271733878;for(c=0;c<i.length;c+=16){v=e;w=f;y=g;x=h;e=j(e,f,g,h,i[c+0],7,3614090360);h=j(h,e,f,g,i[c+1],12,3905402710);g=j(g,h,e,f,i[c+2],17,606105819);f=j(f,g,h,e,i[c+3],22,3250441966);e=j(e,
f,g,h,i[c+4],7,4118548399);h=j(h,e,f,g,i[c+5],12,1200080426);g=j(g,h,e,f,i[c+6],17,2821735955);f=j(f,g,h,e,i[c+7],22,4249261313);e=j(e,f,g,h,i[c+8],7,1770035416);h=j(h,e,f,g,i[c+9],12,2336552879);g=j(g,h,e,f,i[c+10],17,4294925233);f=j(f,g,h,e,i[c+11],22,2304563134);e=j(e,f,g,h,i[c+12],7,1804603682);h=j(h,e,f,g,i[c+13],12,4254626195);g=j(g,h,e,f,i[c+14],17,2792965006);f=j(f,g,h,e,i[c+15],22,1236535329);e=k(e,f,g,h,i[c+1],5,4129170786);h=k(h,e,f,g,i[c+6],9,3225465664);g=k(g,h,e,f,i[c+11],14,643717713);
f=k(f,g,h,e,i[c+0],20,3921069994);e=k(e,f,g,h,i[c+5],5,3593408605);h=k(h,e,f,g,i[c+10],9,38016083);g=k(g,h,e,f,i[c+15],14,3634488961);f=k(f,g,h,e,i[c+4],20,3889429448);e=k(e,f,g,h,i[c+9],5,568446438);h=k(h,e,f,g,i[c+14],9,3275163606);g=k(g,h,e,f,i[c+3],14,4107603335);f=k(f,g,h,e,i[c+8],20,1163531501);e=k(e,f,g,h,i[c+13],5,2850285829);h=k(h,e,f,g,i[c+2],9,4243563512);g=k(g,h,e,f,i[c+7],14,1735328473);f=k(f,g,h,e,i[c+12],20,2368359562);e=l(e,f,g,h,i[c+5],4,4294588738);h=l(h,e,f,g,i[c+8],11,2272392833);
g=l(g,h,e,f,i[c+11],16,1839030562);f=l(f,g,h,e,i[c+14],23,4259657740);e=l(e,f,g,h,i[c+1],4,2763975236);h=l(h,e,f,g,i[c+4],11,1272893353);g=l(g,h,e,f,i[c+7],16,4139469664);f=l(f,g,h,e,i[c+10],23,3200236656);e=l(e,f,g,h,i[c+13],4,681279174);h=l(h,e,f,g,i[c+0],11,3936430074);g=l(g,h,e,f,i[c+3],16,3572445317);f=l(f,g,h,e,i[c+6],23,76029189);e=l(e,f,g,h,i[c+9],4,3654602809);h=l(h,e,f,g,i[c+12],11,3873151461);g=l(g,h,e,f,i[c+15],16,530742520);f=l(f,g,h,e,i[c+2],23,3299628645);e=m(e,f,g,h,i[c+0],6,4096336452);
h=m(h,e,f,g,i[c+7],10,1126891415);g=m(g,h,e,f,i[c+14],15,2878612391);f=m(f,g,h,e,i[c+5],21,4237533241);e=m(e,f,g,h,i[c+12],6,1700485571);h=m(h,e,f,g,i[c+3],10,2399980690);g=m(g,h,e,f,i[c+10],15,4293915773);f=m(f,g,h,e,i[c+1],21,2240044497);e=m(e,f,g,h,i[c+8],6,1873313359);h=m(h,e,f,g,i[c+15],10,4264355552);g=m(g,h,e,f,i[c+6],15,2734768916);f=m(f,g,h,e,i[c+13],21,1309151649);e=m(e,f,g,h,i[c+4],6,4149444226);h=m(h,e,f,g,i[c+11],10,3174756917);g=m(g,h,e,f,i[c+2],15,718787259);f=m(f,g,h,e,i[c+9],21,3951481745);
e=d(e,v);f=d(f,w);g=d(g,y);h=d(h,x)}return(u(e)+u(f)+u(g)+u(h)).toLowerCase()}(a)+".jpg?s="+b};_.fullSelection=function(a){var b;if(document.createRange){b=document.createRange();b.selectNodeContents(a);a=window.getSelection();a.removeAllRanges();a.addRange(b)}else if(document.selection){b=document.body.createTextRange();b.moveToElementText(a);b.collapse(false);b.select()}};
_.prettyDate=function(a){if(a instanceof Date)a=a.toJSON();a=new Date((a||"").replace(/-/g,"/").replace(/[TZ]/g," "));a=((new Date).getTime()-a.getTime())/1E3;var b=Math.floor(a/86400);if(!(isNaN(b)||b<0||b>=31))return b==0&&(a<60&&"just now"||a<120&&"1 minute ago"||a<3600&&Math.floor(a/60)+" minutes ago"||a<7200&&"1 hour ago"||a<86400&&Math.floor(a/3600)+" hours ago")||b==1&&"Yesterday"||b<7&&b+" days ago"||b<31&&Math.ceil(b/7)+" weeks ago"};
_.stripTags=function(a,b){b=(((b||"")+"").toLowerCase().match(/<[a-z][a-z0-9]*>/g)||[]).join("");return a.replace(/<!--[\s\S]*?--\>|<\?(?:php)?[\s\S]*?\?>/gi,"").replace(/<\/?([a-z][a-z0-9]*)\b[^>]*>/gi,function(c,d){return b.indexOf("<"+d.toLowerCase()+">")>-1?c:""})};
var renderControls=function(a,b,c,d){function j(k,l,m){function u(i,v){var w=[];if(i.all("children")&&i.all("children").length===0&&l==="after"){var y=i.properties().get("children").expectedTypes;_.each(y,function(x){w.push({node:i._id,parentNode:v?v._id:null,nodeType:x,nodeTypeName:graph.get(x).name,insertionType:"child"})})}if(v){y=v.properties().get("children").expectedTypes;_.each(y,function(x){w.push({node:i._id,parentNode:v?v._id:null,nodeType:x,nodeTypeName:graph.get(x).name,insertionType:"sibling"})})}if(m&&
i.all("children")&&i.all("children").length>0)w=w.concat(u(i.all("children").last(),i));return w}return Helpers.renderTemplate("controls",{node:k.key,destination:l,actions:u(k,d)})}if(d){b&&$(j(a,"before")).insertBefore($("#"+a.html_id));if(d.types().get("/type/document"))$(j(a,"after",true)).insertAfter($("#"+a.html_id));else c||$(j(a,"after")).insertAfter($("#"+a.html_id))}else{$("#document .controls").remove();if(!a.all("children")||a.all("children").length===0)$(j(a,"after")).appendTo($("#"+a.html_id))}a.all("children")&&
a.all("children").each(function(k,l,m){l=m===0;m=m===a.all("children").length-1;renderControls(k,l,m,a)})},HTMLRenderer=function(a,b){var c={"/type/document":function(d){var j="",k=d.all("children");k&&k.each(function(l){j+=c[l.type._id](l,d)});return _.tpl("document",{node:d,content:j,edit:app.document.mode==="edit",title:d.get("title"),lead:d.get("lead"),empty_lead:app.document.mode==="edit"&&(!d.get("lead")||d.get("lead")===""),empty_title:app.document.mode==="edit"&&(!d.get("title")||d.get("title")===
"")})},"/type/story":function(d,j){return c["/type/document"](d,j)},"/type/conversation":function(d,j){return c["/type/document"](d,j)},"/type/article":function(d,j){return c["/type/document"](d,j)},"/type/manual":function(d,j){return c["/type/document"](d,j)},"/type/qaa":function(d,j){return c["/type/document"](d,j)},"/type/section":function(d,j){var k="";d.all("children")&&d.all("children").each(function(l){k+=c[l.type._id](l,d)});return Helpers.renderTemplate("section",{node:d,parent:j,content:k,
edit:app.document.mode==="edit",name:d.get("name"),empty:app.document.mode==="edit"&&(!d.get("name")||d.get("name")==="")})},"/type/text":function(d,j){return Helpers.renderTemplate("text",{node:d,parent:j,edit:app.document.mode==="edit",content:d.get("content"),empty:app.document.mode==="edit"&&(!d.get("content")||d.get("content")==="")})},"/type/quote":function(d,j){return Helpers.renderTemplate("quote",{node:d,parent:j,edit:app.document.mode==="edit",content:d.get("content"),author:d.get("author"),
empty_content:app.document.mode==="edit"&&(!d.get("content")||d.get("content")===""),empty_author:app.document.mode==="edit"&&(!d.get("author")||d.get("author")==="")})},"/type/code":function(d,j){return Helpers.renderTemplate("code",{node:d,parent:j,edit:app.document.mode==="edit",content:d.get("content"),empty:app.document.mode==="edit"&&(!d.get("content")||d.get("content")==="")})},"/type/question":function(d,j){return Helpers.renderTemplate("question",{node:d,parent:j,edit:app.document.mode===
"edit",content:d.get("content"),empty:app.document.mode==="edit"&&(!d.get("content")||d.get("content")==="")})},"/type/answer":function(d,j){return Helpers.renderTemplate("answer",{node:d,parent:j,edit:app.document.mode==="edit",content:d.get("content"),empty:app.document.mode==="edit"&&(!d.get("content")||d.get("content")==="")})},"/type/image":function(d,j){return Helpers.renderTemplate("image",{node:d,parent:j,edit:app.document.mode==="edit",url:d.get("url")})},"/type/visualization":function(d,
j){return Helpers.renderTemplate("visualization",{node:d,parent:j,edit:app.document.mode==="edit",visualization_type:d.get("visualization_type"),data_source:d.get("data_source")})}};return{render:function(){return c[a.type._id](a,b)}}},TOCRenderer=function(a){var b={"/type/document":function(c){content="<h2>Table of contents</h2>";content+="<ul>";c.all("children").each(function(d){content+='<li><a class="toc-item" node="'+d.html_id+'" href="#'+a.get("creator")._id.split("/")[2]+"/"+a.get("name")+
"/"+d.html_id+'">'+d.get("name")+"</a></li>"});content+="</ul>";return content},"/type/story":function(c){return b["/type/document"](c)},"/type/conversation":function(){return""},"/type/manual":function(c,d){return b["/type/document"](c,d)},"/type/article":function(c,d){return b["/type/document"](c,d)},"/type/qaa":function(c,d){return b["/type/document"](c,d)}};return{render:function(){return b[a.type._id](a)}}},DocumentEditor=Backbone.View.extend({events:{"keydown .property":"updateNode"},initialize:function(){function a(){if(document.activeElement===
b.$node[0]){if(b.$node.hasClass("empty")){b.$node.html("");_.fullSelection(b.$node[0])}}else if(b.$lead.hasClass("empty")){b.$lead.html("");_.fullSelection(b.$lead[0])}}var b=this;this.$node=$("#"+app.document.selectedNode.html_id+" > h1.content").unbind();this.$lead=$("#"+app.document.selectedNode.html_id+" #document_lead").unbind();a();this.$node.bind("focus",a);this.$lead.bind("focus",a);this.$node.bind("blur",function(){b.updateState("$node")});this.$lead.bind("blur",function(){b.updateState("$lead")});
this.$node.unbind("keydown");this.$node.bind("keydown",function(c){return c.keyCode!==13?b.updateNode():false});this.$lead.unbind("keydown");this.$lead.bind("keydown",function(c){return c.keyCode!==13?b.updateNode():false});return true},updateState:function(a){if(this[a].text().trim().length===0){if(a==="$node"){this[a].html("&laquo; Enter Title &raquo;");app.document.updateSelectedNode({title:""})}else{this[a].html("&laquo; Enter Lead &raquo;");app.document.updateSelectedNode({lead:""})}this[a].addClass("empty")}else this[a].hasClass("empty")&&
this[a].text().trim().length>0&&this[a].removeClass("empty")},updateNode:function(){var a=this;setTimeout(function(){var b=a.$node.hasClass("empty")&&document.activeElement!==a.$node[0]?"":_.stripTags(a.$node.html()),c=a.$lead.hasClass("empty")&&document.activeElement!==a.$lead[0]?"":_.stripTags(a.$lead.html());app.document.updateSelectedNode({title:b,lead:c});app.document.trigger("changed")},5)}}),SectionEditor=Backbone.View.extend({events:{"keydown .property":"updateNode"},initialize:function(){var a=
this;this.render();this.$node=$("#"+app.document.selectedNode.html_id+" > .content").attr("contenteditable",true).unbind();if(this.$node.hasClass("empty")){this.$node.html("");_.fullSelection(this.$node[0])}this.$node.unbind("keydown");this.$node.bind("keydown",function(b){return b.keyCode!==13?a.updateNode():false});this.$node.bind("blur",function(){a.updateState()})},updateState:function(){if(this.$node.text().trim().length===0){this.$node.html("&laquo; Enter Section Name &raquo;");this.$node.addClass("empty");
app.document.updateSelectedNode({content:""})}else this.$node.hasClass("empty")&&this.$node.text().trim().length>0&&this.$node.removeClass("empty")},updateNode:function(){var a=this;setTimeout(function(){var b=_.stripTags(a.$node.html());app.document.updateSelectedNode({name:b})},5)},render:function(){}}),TextEditor=Backbone.View.extend({events:{},initialize:function(){var a=this;this.render();this.$content=this.$("div.content");editor.activate(this.$content);if(this.$content.hasClass("empty")){this.$content.html("");
_.fullSelection(this.$content[0])}editor.bind("changed",function(){a.updateNode()});this.$content.bind("blur",function(){a.updateState();a.$content.unbind("blur")})},updateState:function(){if(this.$content.text().trim().length===0){this.$content.html("&laquo; Enter Text &raquo;");this.$content.addClass("empty");app.document.updateSelectedNode({content:""})}else this.$content.hasClass("empty")&&this.$content.text().trim().length>0&&this.$content.removeClass("empty")},updateNode:function(){var a=this;
setTimeout(function(){app.document.updateSelectedNode({content:a.$content.html()})},5)},render:function(){}}),QuoteEditor=Backbone.View.extend({events:{},initialize:function(){function a(){if(document.activeElement===b.$author[0]){if(b.$author.hasClass("empty")){b.$author.html("");_.fullSelection(b.$author[0])}}else if(b.$content.hasClass("empty")){b.$content.html("");_.fullSelection(b.$content[0])}}var b=this;this.$content=this.$(".quote-content").unbind();this.$author=this.$(".quote-author").unbind();
a();this.$content.bind("focus",a);this.$author.bind("focus",a);this.$content.bind("blur",function(){b.updateState("$content")});this.$author.bind("blur",function(){b.updateState("$author")});this.$content.unbind("keydown");this.$content.bind("keydown",function(c){return c.keyCode!==13?b.updateNode():false});this.$author.unbind("keydown");this.$author.bind("keydown",function(c){return c.keyCode!==13?b.updateNode():false})},updateState:function(a){if(this[a].text().trim().length===0){if(a==="$content"){this[a].html("&laquo; Enter Quote &raquo;");
app.document.updateSelectedNode({content:""})}else{this[a].html("&laquo; Enter Author &raquo;");app.document.updateSelectedNode({author:""})}this[a].addClass("empty")}else this[a].hasClass("empty")&&this[a].text().trim().length>0&&this[a].removeClass("empty")},updateNode:function(){var a=this;setTimeout(function(){var b=a.$content.hasClass("empty")&&document.activeElement!==a.$content[0]?"":_.stripTags(a.$content.html()),c=a.$author.hasClass("empty")&&document.activeElement!==a.$author[0]?"":_.stripTags(a.$author.html());
app.document.updateSelectedNode({content:b,author:c})},5)},render:function(){}}),CodeEditor=Backbone.View.extend({events:{},initialize:function(){var a=this;this.render();this.$content=this.$(".content");editor.activate(this.$content);$(".proper-commands").hide();if(this.$content.hasClass("empty")){this.$content.html("");_.fullSelection(this.$content[0])}editor.bind("changed",function(){a.updateNode()});this.$content.bind("blur",function(){a.updateState();a.$content.unbind("blur")})},updateState:function(){if(this.$content.text().trim().length===
0){this.$content.html("&laquo; Enter code &raquo;");this.$content.addClass("empty");app.document.updateSelectedNode({content:""})}else this.$content.hasClass("empty")&&this.$content.text().trim().length>0&&this.$content.removeClass("empty")},updateNode:function(){var a=this;setTimeout(function(){app.document.updateSelectedNode({content:a.$content.html()})},5)},render:function(){}}),QuestionEditor=Backbone.View.extend({events:{},initialize:function(){var a=this;this.render();this.$content=this.$(".content");
editor.activate(this.$content);$(".proper-commands").hide();if(this.$content.hasClass("empty")){this.$content.html("");_.fullSelection(this.$content[0])}editor.bind("changed",function(){a.updateNode()});this.$content.bind("blur",function(){a.updateState();a.$content.unbind("blur")})},updateState:function(){if(this.$content.text().trim().length===0){this.$content.html("&laquo; Enter Question &raquo;");this.$content.addClass("empty");app.document.updateSelectedNode({content:""})}else this.$content.hasClass("empty")&&
this.$content.text().trim().length>0&&this.$content.removeClass("empty")},updateNode:function(){var a=this;setTimeout(function(){app.document.updateSelectedNode({content:a.$content.html()})},5)},render:function(){}}),AnswerEditor=Backbone.View.extend({events:{},initialize:function(){var a=this;this.render();this.$content=this.$(".content");editor.activate(this.$content);$(".proper-commands").hide();if(this.$content.hasClass("empty")){this.$content.html("");_.fullSelection(this.$content[0])}editor.bind("changed",
function(){a.updateNode()});this.$content.bind("blur",function(){a.updateState();a.$content.unbind("blur")})},updateState:function(){if(this.$content.text().trim().length===0){this.$content.html("&laquo; Enter Answer &raquo;");this.$content.addClass("empty");app.document.updateSelectedNode({content:""})}else this.$content.hasClass("empty")&&this.$content.text().trim().length>0&&this.$content.removeClass("empty")},updateNode:function(){var a=this;setTimeout(function(){app.document.updateSelectedNode({content:a.$content.html()})},
5)},render:function(){}}),ImageEditor=Backbone.View.extend({events:{},initialize:function(){this.render();$("#upload_image").transloadit({modal:false,wait:true,autoSubmit:false,onProgress:function(a,b){percentage=(a/b*100).toFixed(2)||0;$("#upload_progress").attr("style","width:"+percentage+"%");$("#image_progress_legend").html("<strong>Uploading:</strong> "+percentage+"% complete</div>")},onError:function(a){console.log(a.error+": "+a.message);$("#progress_container").hide()},onStart:function(){$("#progress_container").show()},
onSuccess:function(a){app.document.updateSelectedNode({url:a.results.resize_image[0].url,dirty:true});$("#progress_container").hide()}})},render:function(){this.$(".node-editor-placeholder").html(Helpers.renderTemplate("edit_image",app.editor.model.selectedNode.data))}}),ApplicationController=Backbone.Controller.extend({routes:{"^(?!search)(.*)/(.*)$":"loadDocument","^(?!search)(.*)/(.*)/(.*)$":"loadDocument",":username":"userDocs","^search/(.*)$":"searchDocs"},loadDocument:function(a,b,c){app.browser.load({type:"user",
value:a});app.document.loadDocument(a,b,c);$("#document_wrapper").attr("url","#"+a+"/"+b);$("#browser_wrapper").attr("url","#"+a);return false},userDocs:function(a){if(!a)if(app.username)a=app.username;else return app.toggleStartpage();a==="recent"?app.browser.load({type:"recent",value:50}):app.browser.load({type:"user",value:a});$("#browser_wrapper").attr("url","#"+a);app.browser.bind("loaded",function(){app.toggleView("browser");app.browser.unbind("loaded")});return false},searchDocs:function(a){app.searchDocs(a);
return false}}),UI={};UI.StringEditor=Backbone.View.extend({events:{"change input":"updateValue"},initialize:function(a){var b=this;this._value=a.value;this.bind("changed",function(){b.render()});this.render()},updateValue:function(){this._value=this.$("input[name=value]").val();this.trigger("changed");this.render();return false},value:function(){return this._value},render:function(){$(this.el).html(_.renderTemplate("string_editor",{value:this._value}))}});
UI.MultiStringEditor=Backbone.View.extend({events:{"submit form":"newItem","click a.remove-item":"removeItem","click .available-item a":"selectAvailableItem","keydown input":"inputChange","click input":"initInput","blur input":"reset"},initialize:function(a){var b=this;this._items=a.items||[];this._availableItems=a.availableItems;this.bind("changed",function(){b.render()});this.render()},initInput:function(){},reset:function(){this.$(".available-items").empty()},inputChange:function(a){var b=this,
c=this.$(".available-item");if(a.keyCode===40){if(this.selectedIndex<c.length-1)this.selectedIndex+=1;this.teaseSuggestion()}else if(a.keyCode===38){if(this.selectedIndex>=0)this.selectedIndex-=1;this.teaseSuggestion()}else setTimeout(function(){b.trigger("input:changed",b.$("input[name=new_value]").val())},200)},teaseSuggestion:function(){this.$(".available-item");this.$(".available-item.selected").removeClass("selected");this.selectedIndex>=0&&this.selectedIndex<this.$(".available-item").length&&
$(this.$(".available-item")[this.selectedIndex]).addClass("selected")},updateSuggestions:function(a){var b=this;b.$(".available-items").empty();_.each(a,function(c){b.$(".available-items").append($('<div class="available-item"><a href="#" id="'+c._id+'" name="'+c.name+'" value="'+c.name+'">'+c.name+"</a></div>"))});this.selectedIndex=-1},selectAvailableItem:function(a){this.$("input[name=new_value]").val($(a.currentTarget).attr("value"));this.$("input[name=new_value]").focus();return false},newItem:function(){this.selectedIndex>=
0&&this.$("input[name=new_value]").val(this.$(".available-item.selected a").attr("value"));var a=this.$("input[name=new_value]").val();if(!_.include(this._items,a)&&a.length>0){this._items.push(a);this.trigger("changed");this.render();this.$("input[name=new_value]").focus()}else this.trigger("error:alreadyexists");return false},removeItem:function(a){var b=$(a.target).attr("value");this._items=_.reject(this._items,function(c){return c===b});this.trigger("changed");return false},value:function(){return this._items},
render:function(){$(this.el).html(_.renderTemplate("multi_string_editor",{items:this._items}))}});function addEmptyDoc(a,b){var c=graph.get(a);c=graph.set(Data.uuid("/document/"+app.username+"/"),c.meta.template);c.set({creator:"/user/"+app.username,created_at:new Date,updated_at:new Date,name:b});return c}
var Document=Backbone.View.extend({events:{"mouseover .content-node":"highlightNode","mouseout .content-node":"unhighlightNode","click .content-node":"selectNode","click .controls .handle":"showActions","click a.unpublish-document":"unpublishDocument","click a.publish-document":"publishDocument","click a.add_child":"addChild","click a.add_sibling":"addSibling","click a.remove-node":"removeNode",dragstart:"dragStart",dragend:"dragEnd",dragenter:"dragEnter",dragover:"dragOver",dragleave:"dragLeave",
drop:"drop"},loadedDocuments:{},initialize:function(){var a=this;this.attributes=new Attributes({el:"#attributes",model:this.model});this.app=this.options.app;this.mode="show";this.bind("status:changed",function(){a.updateCursors()});this.bind("changed",function(){document.title=a.model.get("title");a.app.browser.render()})},updateCursors:function(){},render:function(){$(this.el).html(_.tpl("document_wrapper",{mode:this.mode,doc:this.model}));this.renderMenu();if(this.model){this.attributes.render();
this.renderDocument()}},renderNode:function(a){var b=$("#"+a.html_id);b=graph.get(b.attr("parent"));$("#"+a.html_id).replaceWith((new HTMLRenderer(a,b)).render());this.mode==="edit"?renderControls(this.app.document.model):hijs("#"+a.html_id+" .content-node.code pre")},renderDocument:function(){this.$("#document").html((new HTMLRenderer(this.model)).render());this.$("#attributes").show();this.$("#document").show();this.mode==="edit"?renderControls(this.model):hijs(".content-node.code pre")},documentTypes:function(){var a=
[];graph.get("/config/substance").get("document_types").each(function(b,c){a.push({type:c,name:graph.get(c).name})});return a},renderMenu:function(){if(this.model){$("#document_tab").show();$("#document_tab").html(_.tpl("document_tab",{username:this.model.get("creator")._id.split("/")[2],document_name:this.model.get("name")}))}},init:function(){var a=this;this.unbind("select:node");this.bind("select:node",function(b){a.resetSelection();$("#"+b.html_id).addClass("selected");$("#document").addClass("edit-mode");
editor.deactivate();a.renderNodeEditor(b)});this.bind("change:node",function(b){a.renderNode(b)});a.selectedNode=null;$(document).unbind("keyup");$(document).keyup(function(b){b.keyCode==27&&a.reset();b.stopPropagation()});$(document).bind("keydown","alt+down",function(){if(a.selectedNode){var b=$(".controls[node="+a.selectedNode._id+"][destination=after]");if(b){b.addClass("active");$("#document").addClass("insert-mode")}}});$(document).bind("keydown","right",function(){});$(document).bind("keydown",
"left",function(){})},newDocument:function(a,b){this.model=addEmptyDoc(a,b);this.status=null;this.mode="edit";$(this.el).show();this.render();this.loadedDocuments[app.username+"/"+b]=this.model._id;this.init();app.browser&&app.browser.query&&app.browser.query.type==="user"&&app.browser.query.value===app.username&&app.browser.graph.set("objects",this.model._id,this.model);app.toggleView("document");controller.saveLocation("#"+this.app.username+"/"+b);$("#document_wrapper").attr("url","#"+this.app.username+
"/"+b);this.trigger("changed");notifier.notify(Notifications.BLANK_DOCUMENT);return false},loadDocument:function(a,b,c,d){function j(l){k.model=graph.get(l);if(k.model){k.mode=d||(a===this.app.username?"edit":"show");k.render();k.init();k.reset();k.trigger("changed");k.loadedDocuments[a+"/"+b]=l;app.browser.graph.set("objects",l,k.model);app.toggleView("document")}else $("#document_wrapper").html("Document loading failed")}var k=this;$("#tabs").show();c=k.loadedDocuments[a+"/"+b];$("#document_tab").show();
if(c)j(c);else{$("#document_tab").html("&nbsp;&nbsp;&nbsp;Loading...");$.ajax({type:"GET",url:"/documents/"+a+"/"+b,dataType:"json",success:function(l){if(l.status==="error")$("#document_wrapper").html("Document loading failed");else{graph.merge(l.graph);j(l.id)}},error:function(){$("#document_wrapper").html("Document loading failed")}})}},closeDocument:function(){this.model=null;controller.saveLocation("#"+this.app.username);$("#document_wrapper").attr("url","#"+this.app.username);$("#document_tab").hide();
app.toggleView("content");this.render()},deleteDocument:function(a){graph.del(a);app.browser.graph.del(a);app.browser.render();$("#document_tab").hide();setTimeout(function(){app.toggleView("browser")},300);notifier.notify(Notifications.DOCUMENT_DELETED)},reset:function(){if(this.model){$(document.activeElement).blur();this.app.document.selectedNode=null;this.resetSelection();return false}},resetSelection:function(){this.$(".content-node.selected").removeClass("selected");$("#document .controls.active").removeClass("active");
$("#document").removeClass("edit-mode");$("#document").removeClass("insert-mode");$(".proper-commands").hide();$(".node-editor-placeholder").html("")},renderNodeEditor:function(a){a=$("#"+a.html_id);if(this.mode==="edit")if(_.include(this.selectedNode.types().keys(),"/type/document"))this.nodeEditor=new DocumentEditor({el:$("#drawer_content")});else if(this.selectedNode.type._id==="/type/text")this.nodeEditor=new TextEditor({el:a});else if(this.selectedNode.type._id==="/type/section")this.nodeEditor=
new SectionEditor({el:a});else if(this.selectedNode.type._id==="/type/image")this.nodeEditor=new ImageEditor({el:a});else if(this.selectedNode.type._id==="/type/quote")this.nodeEditor=new QuoteEditor({el:a});else if(this.selectedNode.type._id==="/type/code")this.nodeEditor=new CodeEditor({el:a});else if(this.selectedNode.type._id==="/type/question")this.nodeEditor=new QuestionEditor({el:a});else if(this.selectedNode.type._id==="/type/answer")this.nodeEditor=new AnswerEditor({el:a})},updateNode:function(a,
b){var c=graph.get(a);c.set(b);this.trigger("change:node",c)},updateSelectedNode:function(a){if(this.selectedNode){this.selectedNode.set(a);this.model.set({updated_at:new Date});a.dirty&&this.trigger("change:node",this.selectedNode);this.selectedNode.type.key==="/type/document"&&this.trigger("changed");this.status&&this.status.collaborators.length>1&&delete this.selectedNode.toJSON().children}},showActions:function(a){this.reset();$(a.target).parent().parent().addClass("active");$("#document").addClass("insert-mode");
return false},highlightNode:function(a){$(a.currentTarget).addClass("active");return false},unhighlightNode:function(a){$(a.currentTarget).removeClass("active");return false},selectNode:function(a){if(this.mode!=="show"){var b=$(a.currentTarget).attr("name");this.$lead=$("#document_lead");if(!this.selectedNode||this.selectedNode.key!==b){this.selectedNode=graph.get(b);this.trigger("select:node",this.selectedNode)}a.stopPropagation();return false}},publishDocument:function(){this.model.set({published_on:(new Date).toJSON()});
this.render();return false},unpublishDocument:function(){this.model.set({published_on:null});this.render();return false},addChild:function(a){if(arguments.length===1){var b=$(a.currentTarget).attr("type"),c=graph.get($(a.currentTarget).attr("node"));b=graph.set(null,{type:b,document:this.model._id})}else{c=graph.get(arguments[1]);b=graph.set(arguments[0].nodeId,arguments[0])}c.all("children").set(b._id,b);c.dirty=true;this.trigger("change:node",c);this.selectedNode=b;this.trigger("select:node",this.selectedNode);
return false},addSibling:function(a){if(arguments.length===1){var b=$(a.currentTarget).attr("type"),c=graph.get($(a.currentTarget).attr("node")),d=graph.get($(a.currentTarget).attr("parent")),j=$(a.currentTarget).parent().parent().attr("destination");b=graph.set(null,{type:b,document:this.model._id})}else{c=graph.get(arguments[1]);d=graph.get(arguments[2]);j=arguments[3];b=graph.set(arguments[0].nodeId,arguments[0])}c=d.all("children").index(c._id);if(j==="after")c+=1;d.all("children").set(b._id,
b,c);d.dirty=true;this.trigger("change:node",d);this.selectedNode=b;this.trigger("select:node",this.selectedNode);return false},removeNode:function(a){if(arguments.length===1)var b=graph.get($(a.currentTarget).attr("node")),c=graph.get($(a.currentTarget).attr("parent"));else{b=graph.get(arguments[0]);c=graph.get(arguments[1])}c.all("children").del(b._id);graph.del(b._id);c.dirty=true;this.trigger("change:node",c);return false}}),Attributes=Backbone.View.extend({initialize:function(){},render:function(){app.document.mode===
"edit"?this.renderEdit():this.renderShow()},renderShow:function(){var a=app.document.model,b=[];b=a.properties().select(function(c){if(c.expectedTypes[0]==="/type/attribute")return true});$(this.el).html(_.tpl("show_attributes",{attributes:b,doc:a}))},availableAttributes:function(a){return graph.find({"type|=":["/type/attribute"],member_of:"/"+a.type._id.split("/")[2]+"/"+a.key})},renderEdit:function(){var a=this,b=app.document.model,c=[];c=b.properties().select(function(d){if(d.expectedTypes[0]===
"/type/attribute")return true});$(this.el).html(_.tpl("edit_attributes",{attributes:c,doc:b}));$(".attribute-editor").each(function(){var d=$(this).attr("property");graph.get("/type/"+d.split("/")[1]).get("properties",d.split("/")[2]);var j=$(this).attr("key"),k=$(this).hasClass("unique"),l=$(this).attr("type");value=k?app.document.model.get(j).get("name"):_.map(app.document.model.get(j).values(),function(u){return u.get("name")});var m=a.createAttributeEditor(j,l,k,value,$(this));m.bind("input:changed",
function(u){if(u.length<2)return m.updateSuggestions({});$.ajax({type:"GET",data:{member:d,search_str:u},url:"/attributes",dataType:"json"}).success(function(i){graph.merge(i.graph);m.updateSuggestions(i.graph)})});m.bind("changed",function(){var u=[];_.each(m.value(),function(v){var w=graph.find({"type|=":["/type/attribute"],member_of:d,name:v}).first();w||(w=graph.set(null,{type:["/type/attribute"],member_of:d,name:v}));u.push(w._id)});var i={};i[j]=u;app.document.model.set(i);app.document.trigger("changed")})})},
createAttributeEditor:function(a,b,c,d,j){switch(b){case "string":return c?this.createStringEditor(a,d,j):this.createMultiStringEditor(a,d,j);case "number":break;case "boolean":break}},createMultiStringEditor:function(a,b,c){return new UI.MultiStringEditor({el:c,items:b})},createStringEditor:function(a,b,c){return new UI.StringEditor({el:c,value:b})}}),AddCriterion=function(a,b){this.app=a;this.options=b};
AddCriterion.prototype.matchesInverse=function(a){return a instanceof RemoveCriterion&&this.options.property===a.options.property&&this.options.operator==="CONTAINS"&&a.options.operator==="CONTAINS"&&this.options.value===a.options.value};AddCriterion.prototype.matchesOverride=function(){};
AddCriterion.prototype.execute=function(){this.graph=app.browser.graph;var a=new Data.Criterion(this.options.operator,"/type/document",this.options.property,this.options.value);app.browser.graph=app.browser.graph.filter(a);this.app.facets.addChoice(this.options.property,this.options.operator,this.options.value)};AddCriterion.prototype.unexecute=function(){app.browser.graph=this.graph;this.app.facets.removeChoice(this.options.property,this.options.operator,this.options.value)};
var RemoveCriterion=function(a,b){this.app=a;this.options=b};RemoveCriterion.prototype.execute=function(){};RemoveCriterion.prototype.unexecute=function(){};
var DocumentBrowser=Backbone.View.extend({events:{"click a.add-criterion":"addCriterion","click a.remove-criterion":"removeCriterion"},addCriterion:function(a){var b=$(a.currentTarget).attr("property"),c=$(a.currentTarget).attr("operator");a=$(a.currentTarget).attr("value");this.applyCommand({command:"add_criterion",options:{property:b,operator:c,value:a}});this.render();return false},removeCriterion:function(a){var b=$(a.currentTarget).attr("property"),c=$(a.currentTarget).attr("operator");a=$(a.currentTarget).attr("value");
this.applyCommand({command:"remove_criterion",options:{property:b,operator:c,value:a}});this.render();return false},initialize:function(a){this.app=a.app;this.browserTab=new BrowserTab({el:"#browser_tab",browser:this});this.documents=[];this.commands=[]},load:function(a){var b=this;this.query=a;this.graph=new Data.Graph(seed);$("#browser_tab").show().html("&nbsp;&nbsp;&nbsp;Loading documents...");$("#browser_wrapper").html("");$.ajax({type:"GET",url:"/documents/search/"+a.type+"/"+encodeURI(a.value),
dataType:"json",success:function(c){b.graph.merge(c.graph);b.facets=new Facets({el:"#facets",browser:b});b.loaded=true;b.trigger("loaded");b.render()},error:function(){}})},render:function(){if(this.loaded){this.documents=this.graph.find({"type|=":"/type/document"});this.documents=this.documents.sort(function(a,b){var c=a.value.get("updated_at"),d=b.value.get("updated_at");return c===d?0:c>d?-1:1});$(this.el).html(_.tpl("document_browser",{documents:this.documents,user:this.query.type==="user"?this.graph.get("/user/"+
this.query.value):null}));this.loaded&&this.facets.render();this.browserTab.render()}},applyCommand:function(a){var b;if(a.command==="add_criterion")b=new AddCriterion(this,a.options);else if(a.command==="remove_criterion")b=new RemoveCriterion(this,a.options);this.currentCommand<this.commands.length-1&&this.commands.splice(this.currentCommand+1);var c=undefined;$.each(this.commands,function(d,j){if(j.matchesInverse(b))c=d});if(c>=0){this.commands[c].unexecute();this.commands.splice(c,1);for(a=c;a<
this.commands.length;a++)this.commands[a].execute()}else{this.commands.push(b);b.execute()}this.currentCommand=this.commands.length-1;return b},undo:function(){if(this.currentCommand>=0){this.commands[this.currentCommand].unexecute();this.currentCommand-=1;this.render()}},redo:function(){if(this.currentCommand<this.commands.length-1){this.currentCommand+=1;this.commands[this.currentCommand].execute();this.render()}}}),Facets=Backbone.View.extend({initialize:function(a){this.browser=a.browser;this.facetChoices=
{}},select:function(a){$(".facet").removeClass("selected");$("#facet_"+a).toggleClass("selected")},addChoice:function(a,b,c){this.facetChoices[a+"::"+b+"::"+c]=true},removeChoice:function(a,b,c){delete this.facetChoices[a+"::"+b+"::"+c]},buildView:function(){var a=this,b={facets:[]},c=new Data.Hash;app.browser.graph.get("/config/substance").get("document_types").each(function(d){c=c.union(app.browser.graph.get(d).properties())});app.browser.graph.get("/type/document").all("properties").each(function(d,
j){if(d.meta.facet){var k=[],l=[];d.all("values").each(function(m){a.facetChoices[j+"::CONTAINS::"+m._id]===true?l.push({key:escape(m._id),value:m.toString(),item_count:m.referencedObjects.length}):k.push({key:escape(m._id),value:m.toString(),item_count:m.referencedObjects.length})});k.length+l.length>0&&b.facets.push({property:j,property_name:d.name,facet_choices:k,selected_facet_choices:l})}});return b},render:function(){$(this.el).html(_.renderTemplate("facets",this.buildView()))}}),Collaborators=
Backbone.View.extend({initialize:function(){this.render()},render:function(){$(this.el).html(Helpers.renderTemplate("collaborators",{status:app.editor.status,id:app.editor.model.id,author:app.editor.model.author,name:app.editor.model.name,hostname:window.location.hostname+(window.location.port!==80?":"+window.location.port:"")}))}}),UserSettings=Backbone.View.extend({events:{"submit form":"updateUser"},updateUser:function(){this.$("#user_password").val()===""||this.$("#user_password").val()===this.$("#user_password_confirmation").val()?
$.ajax({type:"POST",url:"/updateuser",data:{username:this.$("#user_username").val(),name:this.$("#user_name").val(),email:this.$("#user_email").val(),password:this.$("#user_password").val(),website:this.$("#user_website").val(),company:this.$("#user_company").val(),location:this.$("#user_location").val()},dataType:"json",success:function(a){if(a.status==="error")notifier.notify({message:"An error occured. Check your input",type:"error"});else{graph.merge(a.seed);app.username=a.username;app.render();
app.document.closeDocument();app.browser.load(app.query());app.browser.bind("loaded",function(){app.toggleView("browser")});controller.saveLocation("#"+app.username)}},error:function(){notifier.notify({message:"An error occured. Check your input",type:"error"})}}):notifier.notify({message:"Password and confirmation do not match.",type:"error"});return false},initialize:function(){},render:function(){$(this.el).html(_.tpl("user_settings",{user:graph.get("/user/"+app.username)}))}}),NewDocument=Backbone.View.extend({initialize:function(){},
render:function(){$(this.el).html(_.tpl("new_document",{}))}}),BrowserTab=Backbone.View.extend({events:{"submit #search_form":"loadDocuments","keydown #search":"search","focus #search":"focusSearch","blur #search":"blurSearch"},focusSearch:function(a){this.searchValue=$(a.currentTarget).val();this.active=true;$(a.currentTarget).val("")},blurSearch:function(){var a=this;this.active=false;setTimeout(function(){a.render()},200)},search:function(a){if(a.keyCode===27)return this.blurSearch();var b=this;
if($("#search").val()!=="")if(!b.pendingSearch){b.pendingSearch=true;setTimeout(function(){b.pendingSearch=false;b.active&&$("#search").val()!==""&&$.ajax({type:"GET",url:"/search/"+encodeURI($("#search").val()),dataType:"json",success:function(c){b.$(".results").html("");b.$(".results").append($('<a href="#search/'+encodeURI($("#search").val())+'" class="result-item documents">'+c.document_count+" Documents / "+Object.keys(c.users).length+" Users</a>"));_.each(c.users,function(d){b.$(".results").append($('<a href="#'+
d.username+'" class="result-item user"><div class="username">'+d.username+'</div><div class="full-name">'+(d.name?d.name:"")+'</div><div class="count">User</div></a>'))});$("#browser_tab .results").show()},error:function(){}})},500)}},loadDocuments:function(){app.searchDocs($("#search").val());return this.active=false},loadUser:function(){},initialize:function(a){this.browser=a.browser},render:function(){var a;if(this.browser.query)switch(this.browser.query.type){case "user":a=this.browser.query.value+
"'s documents";break;case "recent":a="Recent Documents";break;default:a="Documents for &quot;"+this.browser.query.value+"&quot;"}else a="Type to search ...";$(this.el).html(_.tpl("browser_tab",{documents:this.browser.documents,query_descr:a}))}}),Header=Backbone.View.extend({events:{"focus #login-user":"focusUser","blur #login-user":"blurUser","focus #login-password":"focusPassword","blur #login-password":"blurPassword"},initialize:function(){},focusUser:function(a){a=$(a.currentTarget);if(a.hasClass("hint")){a.val("");
a.removeClass("hint")}},blurUser:function(a){a=$(a.currentTarget);if(a.val()===""){a.addClass("hint");a.val("username")}},focusPassword:function(a){a=$(a.currentTarget);if(a.hasClass("hint")){a.val("");a.removeClass("hint")}},blurPassword:function(a){a=$(a.currentTarget);if(a.val()===""){a.addClass("hint");a.val("password")}},render:function(){var a=this.options.app.username;$(this.el).html(_.tpl("header",{user:graph.get("/user/"+a)}))}}),Application=Backbone.View.extend({events:{"click .toggle-new-document":"toggleNewDocument",
"click a.scroll-to":"triggerScrollTo","click .new-document":"newDocument","click #dashboard_toggle":"showDashboard","click #document_toggle":"showDocument","click a.load-document":"loadDocument","click a.save-document":"saveDocument","click a.logout":"logout","click a.signup":"toggleSignup","click .tab":"switchTab","click a.show-attributes":"showAttributes","click a.publish-document":"publishDocument","click a.unpublish-document":"unpublishDocument","submit #create_document":"createDocument","submit #login-form":"login",
"click a.delete-document":"deleteDocument","click a.view-collaborators":"viewCollaborators","click a.toggle-document-views":"toggleDocumentViews","click a.toggle-signup":"toggleSignup","click a.toggle-startpage":"toggleStartpage","click a.toggle-edit-mode":"toggleEditMode","click a.toggle-show-mode":"toggleShowMode","click a.toggle-user-settings":"toggleUserSettings","submit #signup-form":"registerUser"},login:function(){this.authenticate();return false},triggerScrollTo:function(a){this.scrollTo($(a.currentTarget).attr("href"));
return false},newDocument:function(){this.content=new NewDocument({el:"#content_wrapper"});this.content.render();this.toggleView("content");return false},toggleUserSettings:function(){this.content=new UserSettings({el:"#content_wrapper"});this.content.render();this.toggleView("content");return false},toggleSignup:function(){app.browser.browserTab.render();$("#content_wrapper").html(_.tpl("signup"));app.toggleView("content");return false},toggleStartpage:function(){app.browser.browserTab.render();
$("#content_wrapper").html(_.tpl("startpage"));app.toggleView("content");return false},searchDocs:function(a){app.browser.load({type:"keyword",value:encodeURI(a)});$("#browser_wrapper").attr("url","#search/"+encodeURI(a));app.browser.bind("loaded",function(){app.toggleView("browser")})},switchTab:function(a){this.toggleView($(a.currentTarget).attr("view"))},toggleView:function(a){$(".tab").removeClass("active");$("#"+a+"_tab").addClass("active");if(!(a==="browser"&&!this.browser.loaded)){$(".view").hide();
$("#"+a+"_wrapper").show();setTimeout(function(){controller.saveLocation($("#"+a+"_wrapper").attr("url"))},200);return false}},createDocument:function(){var a=this,b=$("#create_document input[name=new_document_name]").val(),c=$("#create_document select[name=document_type]").val();if(RegExp(graph.get("/type/document").get("properties","name").validator).test(b)){$.ajax({type:"GET",url:"/documents/"+app.username+"/"+b,dataType:"json",success:function(d){if(d.status==="error")a.document.newDocument(c,
b);else{$("#create_document input[name=new_document_name]").addClass("error");$("#new_document_name_message").html("This document name is already taken.")}},error:function(){$("#document_wrapper").html("Document loading failed")}});return false}else{$("#create_document input[name=new_document_name]").addClass("error");$("#new_document_name_message").html("Invalid document name. No spaces or special characters allowed.")}return false},toggleEditMode:function(){var a=app.document.model.get("creator").get("username"),
b=app.document.model.get("name");app.document.loadDocument(a,b,null,"edit");return false},toggleShowMode:function(){var a=app.document.model.get("creator").get("username"),b=app.document.model.get("name");app.document.loadDocument(a,b,null,"show");return false},loadDocument:function(a){var b=$(a.currentTarget).attr("user");name=$(a.currentTarget).attr("name");app.document.loadDocument(b,name);if(controller){controller.saveLocation($(a.currentTarget).attr("href"));$("#document_wrapper").attr("url",
$(a.currentTarget).attr("href"))}return false},showAttributes:function(){app.document.drawer.toggle("Attributes");$(".show-attributes").toggleClass("selected");return false},logout:function(){var a=this;$.ajax({type:"POST",url:"/logout",dataType:"json",success:function(){a.username=null;a.authenticated=false;a.document.closeDocument();a.browser.loaded=false;a.browser.render();a.render();$("#document_tab").hide();app.toggleStartpage();controller.saveLocation("");$(".new-document").hide()}});return false},
deleteDocument:function(){if(confirm("Are you sure to delete this document?")){this.document.deleteDocument(app.document.model._id);this.document.closeDocument()}return false},updateSystemStatus:function(a){this.activeUsers=a.active_users},query:function(){return this.authenticated?{type:"user",value:this.username}:{type:"user",value:"demo"}},initialize:function(){var a=this;this.browser=new DocumentBrowser({el:this.$("#browser_wrapper"),app:this});this.document=new Document({el:"#document_wrapper",
app:this});this.header=new Header({el:"#header",app:this});this.activeUsers=[];if(session.username){graph.merge(session.seed);this.authenticated=true;this.username=session.username;this.trigger("authenticated");$("#tabs").show();$(".new-document").show()}else this.authenticated=false;this.bind("authenticated",function(){a.authenticated=true;$("#tabs").show();$(".new-document").show();a.render();a.document.closeDocument();a.browser.load(a.query());a.browser.bind("loaded",function(){a.toggleView("browser")});
controller.saveLocation("#"+a.username)});a.render()},connect:function(){var a=this;DNode({Session:{updateStatus:function(b){a.document.status=b;a.document.trigger("status:changed")},updateSystemStatus:function(b){a.updateSystemStatus(b)},updateNode:function(b,c){app.document.updateNode(b,c)},moveNode:function(){throw"Not implemented";},insertNode:function(b,c,d,j,k){b==="sibling"?app.document.addSibling(c,d,j,k):app.document.addChild(c,d,j,k)},removeNode:function(b,c){app.document.removeNode(b,c)},
getDocument:function(b){var c=a.getFullDocument(app.document.model._id);b(c)}}}).connect(function(b){remote=b;a.trigger("connected")})},getFullDocument:function(a){function b(d){if(!c[d]){var j=graph.get(d);c[d]=j.toJSON();j.type.all("properties").each(function(k){k.isObjectType()&&j.all(k.key).each(function(l){l.type&&b(l._id)})})}}var c={};b(a);return c},authenticate:function(){var a=this;$.ajax({type:"POST",url:"/login",data:{username:$("#login-user").val(),password:$("#login-password").val()},
dataType:"json",success:function(b){if(b.status==="error")return notifier.notify(Notifications.AUTHENTICATION_FAILED);else{graph.merge(b.seed);a.username=b.username;a.trigger("authenticated")}},error:function(){notifier.notify(Notifications.AUTHENTICATION_FAILED)}});return false},scrollTo:function(a){(a=$(a).offset())&&$("html, body").animate({scrollTop:a.top},"slow");return false},registerUser:function(){var a=this;$(".page-content .input-message").empty();$("#registration_error_message").empty();
$(".page-content input").removeClass("error");$.ajax({type:"POST",url:"/register",data:{username:$("#signup_user").val(),name:$("#signup_name").val(),email:$("#signup_email").val(),password:$("#signup_password").val()},dataType:"json",success:function(b){if(b.status==="error")if(b.field==="username"){$("#signup_user").addClass("error");$("#signup_user_message").html(b.message)}else $("#registration_error_message").html(b.message);else{graph.merge(b.seed);notifier.notify(Notifications.AUTHENTICATED);
a.username=b.username;a.trigger("authenticated")}},error:function(){$("#registration_error_message").html("Unknown error.")}});return false},render:function(){this.document.render();this.browser.render();this.header.render();return this}});Data.setAdapter("AjaxAdapter");var remote,app,controller,editor,graph=new Data.Graph(seed,false);
(function(){$(function(){app=new Application({el:$("#container"),session:session});editor=new Proper;controller=new ApplicationController({app:this});Backbone.history.start();var a=false;graph.bind("dirty",function(){if(!a){a=true;setTimeout(function(){$("#sync_state").html("Synchronizing...");graph.sync(function(b,c){a=false;if(!b&&c.length===0){$("#sync_state").html("Successfully synced.");setTimeout(function(){$("#sync_state").html("")},3E3)}else{confirm("There was an error during synchronization. The workspace will be reset for your own safety");
window.location.reload(true)}})},3E3)}});graph.bind("conflicted",function(){if(app.document.model){graph.fetch({creator:app.document.model.get("creator")._id,name:app.document.model.get("name")},{expand:true},function(){app.document.render();app.scrollTo("#document_wrapper")});notifier.notify({message:"There are conflicting nodes. The Document will be reset for your own safety.",type:"error"})}})})})();
