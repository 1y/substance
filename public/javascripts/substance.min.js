(function(){window.s={};s.model={};s.util={};s.views={};s.app={}})();
var Notifications={CONNECTED:{message:"Just established a server connection.",type:"info"},AUTHENTICATED:{message:"Successfully authenticated.",type:"success"},AUTHENTICATION_FAILED:{message:"Authentication failed.",type:"error"},SIGNUP_FAILED:{message:"User Registration failed. Check your input",type:"error"},DOCUMENT_LOADING:{message:"Loading document ...",type:"info"},DOCUMENT_LOADED:{message:"Document successfully loaded.",type:"success"},DOCUMENT_LOADING_FAILED:{message:"An error ocurred during loading.",
type:"error"},DOCUMENTS_LOADING:{message:"Loading available documents ...",type:"info"},DOCUMENTS_LOADED:{message:"Documents fetched.",type:"success"},DOCUMENTS_LOADING_FAILED:{message:"An error occured during loading documents",type:"error"},BLANK_DOCUMENT:{message:"You are now editing a blank document.",type:"info"},DOCUMENT_SAVING:{message:"Saving document ...",type:"info"},DOCUMENT_SAVED:{message:"The document has been stored in the repository.",type:"success"},DOCUMENT_SAVING_FAILED:{message:"Error during saving.",
type:"error"},SYNCHRONIZING:{message:"Synchronizing with server ...",type:"info"},SYNCHRONIZED:{message:"Successfully synchronized with server",type:"info"},SYNCHRONIZING_FAILED:{message:"Failed to synchronize with server",type:"error"},DOCUMENT_INVALID:{message:"The document is invalid. Make sure that you've set a correct name for it.",type:"error"},DOCUMENT_ALREADY_EXISTS:{message:"This document name is already taken.",type:"error"},DOCUMENT_DELETING:{message:"Deleting document ...",type:"info"},
DOCUMENT_DELETED:{message:"The document has been deleted.",type:"success"},DOCUMENT_DELETING_FAILED:{message:"Error during deletion.",type:"error"},NEW_COLLABORATOR:{message:"A new collaborator just went online.",type:"info"},EXIT_COLLABORATOR:{message:"One collaborator just left.",type:"info"}};Backbone.Notifier=function(a){a||(a={});this.initialize&&this.initialize(a)};_.extend(Backbone.Notifier.prototype,Backbone.Events,{notify:function(a){this.trigger("message:arrived",a)}});var notifier=new Backbone.Notifier;
notifier.bind("message:arrived",function(a){var b=$('<p class="notification"><span>'+a.type+":</span>"+a.message+"</p>");$("#notifications .wrapper").append(b);if(a.message.indexOf("...")!==-1)b.addClass("activity");else{$("#notifications .wrapper p.activity").remove();setTimeout(function(){b.remove()},4E3)}});if(!window.console)window.console={log:function(){}};
s.util.date=function(a){var b=Date.parse(a),c=0,d;if(isNaN(b)&&(d=/^(\d{4}|[+\-]\d{6})-(\d{2})-(\d{2})(?:[T ](\d{2}):(\d{2})(?::(\d{2})(?:\.(\d{3,}))?)?(?:(Z)|([+\-])(\d{2})(?::?(\d{2}))?))?/.exec(a))){if(d[8]!=="Z"){c=+d[10]*60+ +d[11];if(d[9]==="+")c=0-c}b=Date.UTC(+d[1],+d[2]-1,+d[3],+d[4],+d[5]+c,+d[6],+d[7].substr(0,3))}return(new Date(b)).toDateString()};
s.util.slug=function(a){a=a.replace(/^\s+|\s+$/g,"");a=a.toLowerCase();for(var b=0;b<28;b++)a=a.replace(RegExp("\u00e0\u00e1\u00e4\u00e2\u00e8\u00e9\u00eb\u00ea\u00ec\u00ed\u00ef\u00ee\u00f2\u00f3\u00f6\u00f4\u00f9\u00fa\u00fc\u00fb\u00f1\u00e7\u00b7/_,:;".charAt(b),"g"),"aaaaeeeeiiiioooouuuunc------".charAt(b));return a=a.replace(/[^a-z0-9 -]/g,"").replace(/\s+/g,"-").replace(/-+/g,"-")};s.util.tpl=function(a,b){return _.template(templates[a],b)};
s.util.browserSupported=function(){if(head.browser.mozilla&&head.browser.version>"1.9.2")return true;if(head.browser.webkit&&head.browser.version>"533.0")return true;if(head.browser.opera&&head.browser.version>"11.0")return true;return false};s.util.prettyDate=function(a){return a?jQuery.timeago(a):""};s.util.escape=function(a){return a.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&apos;")};
s.util.unescape=function(a){return a.replace(/&apos;/g,"'").replace(/&quot;/g,'"').replace(/&gt;/g,">").replace(/&lt;/g,"<").replace(/&amp;/g,"&")};var UI={};
UI.StringEditor=Backbone.View.extend({events:{"change input":"updateValue"},initialize:function(a){var b=this;this._value=a.value;this.bind("changed",function(){b.render()});this.render()},updateValue:function(){this._value=this.$("input[name=value]").val();this.trigger("changed");this.render();return false},value:function(){return this._value},render:function(){$(this.el).html(_.tpl("string_editor",{value:this._value}))}});
UI.MultiStringEditor=Backbone.View.extend({events:{"submit form":"newItem","click a.remove-item":"removeItem","click .available-item a":"selectAvailableItem","keydown input":"inputChange","click input":"initInput","blur input":"reset"},initialize:function(a){var b=this;this._items=a.items||[];this._availableItems=a.availableItems;this.bind("changed",function(){b.render()});this.render()},initInput:function(){},reset:function(){this.$(".available-items").empty()},inputChange:function(a){var b=this,
c=this.$(".available-item");if(a.keyCode===40){if(this.selectedIndex<c.length-1)this.selectedIndex+=1;this.teaseSuggestion()}else if(a.keyCode===38){if(this.selectedIndex>=0)this.selectedIndex-=1;this.teaseSuggestion()}else setTimeout(function(){b.trigger("input:changed",b.$("input[name=new_value]").val())},200)},teaseSuggestion:function(){this.$(".available-item");this.$(".available-item.selected").removeClass("selected");this.selectedIndex>=0&&this.selectedIndex<this.$(".available-item").length&&
$(this.$(".available-item")[this.selectedIndex]).addClass("selected")},updateSuggestions:function(a){var b=this;b.$(".available-items").empty();_.each(a,function(c){b.$(".available-items").append($('<div class="available-item"><a href="#" id="'+c._id+'" name="'+c.name+'" value="'+c.name+'">'+c.name+"</a></div>"))});this.selectedIndex=-1},selectAvailableItem:function(a){this.$("input[name=new_value]").val($(a.currentTarget).attr("value"));this.$("input[name=new_value]").focus();return false},newItem:function(){this.selectedIndex>=
0&&this.$("input[name=new_value]").val(this.$(".available-item.selected a").attr("value"));var a=this.$("input[name=new_value]").val();if(!_.include(this._items,a)&&a.length>0){this._items.push(a);this.trigger("changed");this.render();this.$("input[name=new_value]").focus()}else this.trigger("error:alreadyexists");return false},removeItem:function(a){var b=$(a.target).attr("value");this._items=_.reject(this._items,function(c){return c===b});this.trigger("changed");return false},value:function(){return this._items},
render:function(){$(this.el).html(_.tpl("multi_string_editor",{items:this._items}))}});function renderTOC(a,b){b=b||a;var c="";c+="<ol>";a.all("children").each(function(d){if(d.type.key==="/type/section")c+='<li><a href="#'+d.html_id+'">'+d.get("name")+"</a>"+renderTOC(d,b)+"</li>"});c+="</ol>";return c}
s.views.TOC=Backbone.View.extend({id:"toc",events:{"click a":"scrollTo"},scrollTo:function(a){a=$(a.currentTarget).attr("href").slice(1);app.scrollTo(a);app.toggleTOC()},render:function(){$(this.el).html(renderTOC(this.model));return this}});
s.views.Document=Backbone.View.extend({initialize:function(a){_.bindAll(this);this.authorized=a.authorized;this.published=a.published;this.version=a.version;this.node=s.views.Node.create({model:this.model,document:this});this.toc=new s.views.TOC({model:this.model,authorized:this.authorized});this.settings=new s.views.DocumentSettings({model:this.model,authorized:this.authorized});this.publish=new s.views.Publish({model:this.model,docView:this,authorized:this.authorized});this.invite=new s.views.Invite({model:this.model,
authorized:this.authorized});this["export"]=new s.views.Export({model:this.model,authorized:this.authorized});this.subscribers=new s.views.Subscribers({model:this.model,authorized:this.authorized});this.versions=new s.views.Versions({model:this.model,authorized:this.authorized});graph.bind("dirty",_.bind(function(){this.updatePublishState()},this));this.currentView=null;_.bindAll(this,"deselect","onKeydown");$(document.body).keydown(this.onKeydown)},render:function(){$(this.el).html(s.util.tpl("document",
{doc:this.model,authorized:this.authorized}));$(this.toc.render().el).appendTo(this.$("#document"));$(this.node.render().el).appendTo(this.$("#document"));this.authorized&&!this.version&&this.edit();this.$("#document_content").click(this.deselect);return this},remove:function(){$(document.body).unbind("keydown",this.onKeydown);this.$("#document_content").unbind("click",this.deselect);$(this.el).remove();return this},events:{"click .toggle-subscription":"toggleSubscription","click .settings":"toggleSettings",
"click .publish":"togglePublish","click .invite":"toggleInvite","click .subscribers":"toggleSubscribers","click .versions":"toggleVersions","click .export":"toggleExport","click #toc":"toggleTOC","click .toggle-toc":"toggleTOC"},toggleSubscription:function(){this.model.get("subscribed")?unsubscribeDocument(this.model,_.bind(function(){this.$(".action.toggle-subscription a").html("Bookmark");this.$(".tab.subscribers a").html(this.model.get("subscribers"))},this)):subscribeDocument(this.model,_.bind(function(){this.$(".action.toggle-subscription a").html("Remove Bookmark");
this.$(".tab.subscribers a").html(this.model.get("subscribers"))},this));return false},toggleSettings:function(){this.toggleView("settings");return false},togglePublish:function(){this.toggleView("publish");return false},toggleSubscribers:function(){this.toggleView("subscribers");return false},toggleVersions:function(){this.toggleView("versions");return false},toggleInvite:function(){this.toggleView("invite");return false},toggleExport:function(){this.toggleView("export");return false},toggleTOC:function(){$(this.toc.el).is(":hidden")?
$(this.toc.render().el).show():$(this.toc.el).hide();return false},onKeydown:function(a){a.keyCode===27&&this.deselect()},updatePublishState:function(){$("#document_navigation .publish-state").removeClass().addClass("publish-state "+getPublishState(this.model))},edit:function(){this.node.transitionTo("write")},deselect:function(){if(this.node){this.node.deselectNode();window.editor.deactivate();this.$(":focus").blur()}},resizeShelf:function(){var a=this.currentView?$(this.currentView.el).outerHeight():
0,b=a+100;this.$("#document_shelf").css({height:a+"px"});this.$("#document_content").css({"margin-top":b+"px"})},closeShelf:function(){if(this.currentView){this.currentView.unbind("resize",this.resizeShelf);$(this.currentView.el).detach();this.currentView=null;this.$(".document.tab").removeClass("selected");this.resizeShelf()}},toggleView:function(a){var b=this[a],c=this.$("#document_shelf");this.$("#document_content");if(this.currentView&&this.currentView===b)return this.closeShelf();this.$(".document.tab").removeClass("selected");
$(".document.tab."+a).addClass("selected");b.load(_.bind(function(){b.bind("resize",this.resizeShelf);c.empty();c.append(b.el);this.currentView=b;b.render()},this))}});s.views.Export=Backbone.View.extend({className:"shelf-content",id:"document_export",render:function(){$(this.el).html(s.util.tpl("document_export",{baseUrl:document.location.href}));this.trigger("resize");return this},load:function(a){a(null)}});
s.views.Invite=Backbone.View.extend({className:"shelf-content",id:"document_invite",initialize:function(){_.bindAll(this);this.collaborators=null},render:function(){$(this.el).html(s.util.tpl("document_invite",{collaborators:this.collaborators,document:this.model}));this.trigger("resize");return this},load:function(a){this.collaborators?a(null):getCollaborators(this.model,_.bind(function(b,c){if(!b)this.collaborators=c;a(b)},this))},events:{"submit form":"invite","change .change-mode":"changeMode",
"click .remove-collaborator":"removeCollaborator"},changeMode:function(a){var b=$(a.currentTarget).attr("data-collaborator");a=$(a.currentTarget).val();changeCollaboratorMode(b,a,_.bind(function(){this.render()},this));return false},removeCollaborator:function(a){var b=$(a.currentTarget).attr("data-collaborator");removeCollaborator(b,_.bind(function(){this.collaborators.del(b);this.render()},this));return false},invite:function(a){a.preventDefault();a.stopPropagation();a=this.$("#collaborator_email").val();
var b=this.$("#collaborator_mode").val();invite(a,this.model,b,_.bind(function(){this.collaborators=null;this.load(this.render)},this))}});
s.views.Publish=Backbone.View.extend({className:"shelf-content",id:"document_publish",initialize:function(a){_.bindAll(this);this.docView=a.docView;this.data=null},render:function(){$(this.el).html(s.util.tpl("document_publish",{availableNetworks:this.data.availableNetworks,networks:this.data.networks,versions:this.data.versions,document:this.model}));this.trigger("resize");this.$("select.networks-selection").chosen();return this},load:function(a){this.data?a(null):loadPublish(this.model,_.bind(function(b,
c){if(!b)this.data=c;a(b)},this))},events:{"click .publish-document":"publishDocument","click .unpublish-document":"unpublishDocument"},publishDocument:function(){var a=this.$(".networks-selection").val()||[],b=this.$("#version_remark").val();publishDocument(this.model,a,b,_.bind(function(){this.data=null;this.docView.updatePublishState();this.docView.closeShelf()},this));return false},unpublishDocument:function(){unpublishDocument(this.model,_.bind(function(){this.data=null;this.docView.updatePublishState();
this.docView.closeShelf()},this));return false}});
s.views.DocumentSettings=Backbone.View.extend({className:"shelf-content",id:"document_settings",initialize:function(){},initializeUploadForm:function(){_.bindAll(this,"onStart","onProgress","onError");this.$(".upload-image-form").transloadit({modal:false,wait:true,autoSubmit:false,onStart:this.onStart,onProgress:this.onProgress,onError:this.onError,onSuccess:_.bind(function(a){a.results.web_version&&a.results.web_version[1]&&a.results.web_version[1].url?this.onSuccess(a):this.onInvalid()},this)})},
onStart:function(){this.$(".image-progress").show();this.$(".image-progress .label").html("Uploading &hellip;");this.$(".progress-bar").css("width","0%")},onProgress:function(a,b){var c=Math.max(0,parseInt(a/b*100));c||(c=0);this.$(".image-progress .label").html("Uploading &hellip; "+c+"%");this.$(".progress-bar").css("width",c+"%")},onSuccess:function(a){this.$(".image-progress").hide();$(".upload-image-form img").attr("src",a.results.web_version[1].url);this.model.set({cover:a.results.web_version[1].url})},
onError:function(){},onInvalid:function(){this.$(".image-progress .label").html("Invalid image. Skipping &hellip;");this.$(".image-progress").hide();setTimeout(_.bind(function(){this.$(".info").show()},this),3E3)},render:function(){$(this.el).html(s.util.tpl("document_settings",{doc:this.model,transloadit_params:config.transloadit.document_cover}));this.initializeUploadForm();this.trigger("resize");return this},load:function(a){a(null)},events:{"click .delete":"deleteDocument","keyup #new_name":"changeName",
"submit .rename":"rename","change .image-file":"upload"},upload:function(){this.$(".upload-image-form").submit()},deleteDocument:function(a){a.preventDefault();a.stopPropagation();confirm("Are you sure you want to delete this document?")&&deleteDocument(this.model,function(){router.navigate("",true)})},changeName:function(a){a.preventDefault();a.stopPropagation()},rename:function(a){a.preventDefault();a.stopPropagation();a=this.$("#new_name").val();this.$(".error").text("");updateDocumentName(this.model,
a,_.bind(function(b){b?this.$(".error").text(b.message):router.navigate(documentURL(this.model),false)},this))}});
s.views.Subscribers=Backbone.View.extend({className:"shelf-content",id:"document_subscribers",initialize:function(){_.bindAll(this);this.data=null},render:function(){$(this.el).html(s.util.tpl("document_subscribers",{document:this.model,subscriptions:this.data.subscriptions}));this.trigger("resize");return this},load:function(a){this.data?a(null):loadSubscribers(this.model,_.bind(function(b,c){if(!b)this.data=c;a(b)},this))},events:{}});
s.views.Versions=Backbone.View.extend({className:"shelf-content",id:"document_versions",events:{"click .remove-version":"__removeVersion","click .toggle-version":"__toggleVersion"},__toggleVersion:function(a){a=$(a.currentTarget).attr("href").replace(/^\//,"");router.navigate(a,true);return false},__removeVersion:function(a){a=$(a.currentTarget).attr("data-version");removeVersion(this.model,a,_.bind(function(){this.data=null;this.load(this.render)},this));return false},initialize:function(){_.bindAll(this);
this.data=null},render:function(){$(this.el).html(s.util.tpl("document_versions",{document:this.model,versions:this.data.versions}));this.trigger("resize");return this},load:function(a){this.data?a(null):loadVersions(this.model,_.bind(function(b,c){if(!b)this.data=c;a(b)},this))}});
s.views.ConfirmCollaboration=Backbone.View.extend({events:{"click a.option-tab":"selectOption","submit #login-form":"login","submit #signup-form":"register","submit #confirm-form":"doConfirm"},initialize:function(){},selectOption:function(a){a=$(a.currentTarget).attr("option");this.$(".option").removeClass("active");this.$(".option-tab").removeClass("active");this.$(".option."+a).addClass("active");this.$(".option-tab."+a).addClass("active");return false},doConfirm:function(){var a=this;this.confirm(function(b){if(b)return alert("Collaboration could not be confirmed. "+
b.error);window.location.href="/"+a.model.document.get("creator")._id.split("/")[2]+"/"+a.model.document.get("name")});return false},confirm:function(a){$.ajax({type:"POST",url:"/confirm_collaborator",data:{tan:this.model.tan,user:app.username},dataType:"json",success:function(b){if(b.error)return a({error:b.error});a(null)},error:function(){a({error:"Error occurred"})}})},login:function(){var a=this;login(this.$(".username").val(),this.$(".password").val(),function(b){if(b)return notifier.notify(Notifications.AUTHENTICATION_FAILED);
a.confirm(function(c){if(c)return alert("Collaboration could not be confirmed. "+c.error);window.location.href="/"+a.model.document.get("creator")._id.split("/")[2]+"/"+a.model.document.get("name")})});return false},register:function(){$(".page-content .input-message").empty();$("#registration_error_message").empty();$(".page-content input").removeClass("error");createUser($("#signup_user").val(),$("#signup_name").val(),$("#signup_email").val(),$("#signup_password").val(),function(a,b){if(a)if(b.field===
"username"){$("#signup_user").addClass("error");$("#signup_user_message").html(b.message)}else $("#registration_error_message").html(b.message);else{notifier.notify(Notifications.AUTHENTICATED);window.location.href="/"+b.username}});return false},render:function(){var a=this.model.collaborator.get("user");if(a&&a._id==="/user/"+app.username)window.location.href="/"+this.document.get("creator")._id.split("/")[2]+"/"+this.document.get("name");else{$(this.el).html(s.util.tpl("confirm_collaboration",
this.model));return this}}});s.views.RecoverPassword=Backbone.View.extend({events:{"submit form":"requestReset"},requestReset:function(){var a=$("#username").val();requestPasswordReset(a,_.bind(function(b){if(b)$("#registration_error_message").html("Username does not exist.");else{$(".recover").hide();$(".success").show()}},this));return false},render:function(){$(this.el).html(s.util.tpl("recover_password",{}));return this}});
s.views.ResetPassword=Backbone.View.extend({events:{"submit form":"resetPassword"},resetPassword:function(){var a=this.$("#password").val(),b=this.$("#password_confirmation").val();if(a!==b)alert("Password and confirmation do not match!");else{resetPassword(this.username,this.tan,a,_.bind(function(c){if(c)$("#registration_error_message").html(c);else window.location.href="/"},this));return false}},initialize:function(a){this.username=a.username;this.tan=a.tan},render:function(){$(this.el).html(s.util.tpl("reset_password",
{}));return this}});function createDoc(a,b,c){a=graph.get(a);a=graph.set(Data.uuid("/document/"+app.username+"/"),a.meta.template);a.set({creator:"/user/"+app.username,created_at:new Date,updated_at:new Date,name:b,title:c});return a}function Position(a,b){this.parent=a;this.after=b}Position.prototype.toString=function(){return"new Position("+this.parent+", "+this.after+")"};function getDocument(a){return a.get("document")||a}function isSection(a){return a.type.key==="/type/section"}
function isLastChild(a,b){return a.all("children").last()===b}function removeChild(a,b,c){var d=isLastChild(a,b);a.all("children").del(b._id);c||graph.del(b._id);a._dirty=true;b.trigger("removed");d&&a.trigger("last-child-changed")}function removeChildTemporary(a,b){removeChild(a,b,true)}
function addChild(a,b){var c=b.parent,d=b.after;d=d===null?0:c.all("children").index(d._id)+1;c.all("children").set(a._id,a,d);c._dirty=true;if(isSection(a)){for(var e=a,g;(g=e.all("children").last())&&isSection(g);)e=g;addFollowingSiblings(new Position(c,a),e)}c.trigger("added-child",a,d);isLastChild(c,a)&&c.trigger("last-child-changed")}function moveChild(a,b,c){removeChildTemporary(a,b);addChild(b,c)}
function createNode(a,b){var c=graph.set(null,{type:a,document:getDocument(b.parent)._id});addChild(c,b);return c}function getFollowingSiblings(a){function b(d,e){var g=new Data.Hash;d.each(function(h,i,j){j>=e&&g.set(i,h)});return g}var c=a.after;a=a.parent.all("children");return c===null?a.clone():b(a,a.index(c._id)+1)}
function addFollowingSiblings(a,b){var c=a.parent,d=false;getFollowingSiblings(a).each(function(e){if(d||isSection(e))d=true;else{var g=new Position(b,b.all("children").last()||null);moveChild(c,e,g)}})}function updateNode(a,b){a.set(b);getDocument(a).set({updated_at:new Date})}
function possibleChildTypes(a,b){function c(g,h){var i=h.indexOf(g);return i>=0?i:Infinity}function d(g,h,i){var j=g.after,l=g.parent.properties().get("children").expectedTypes;_.each(l,function(n){if(!(n==="/type/section"&&i>3)){var p=h.get(n);p?p.push(g):h.set(n,[g])}});j&&j.properties().get("children")&&d(new Position(j,j.all("children").last()),h,i+1);return h}var e=["/type/section","/type/text","/type/image","/type/resource","/type/quote","/type/code"];return d(a,new Data.Hash,b).sort(function(g,
h){return function(i,j){return g(h(i),h(j))}}(function(g,h){return c(g,e)<c(h,e)?-1:1},function(g){return g.key}))}function getTypeName(a){return graph.get(a).name}
function moveTargetPositions(a,b,c){function d(h){return isSection(h)?1+Math.max(_.max(_.map(h.all("children").values(),d)),0):0}function e(h,i,j){var l=h.after;if(j>g)return i;h.parent.properties().get("children").expectedTypes.indexOf(a.type.key)>=0&&i.push(h);if(l&&l.properties().get("children"))e(new Position(l,l.all("children").last()||null),i,j+1);return i}var g=4-d(a);return e(b,[],c)}
function loadComments(a,b){graph.fetch({type:"/type/comment",node:a._id},function(c,d){if(c)return b(c,null);b(null,d.sort(function(e,g){var h=e.value.get("created_at"),i=g.value.get("created_at");return h===i?0:h<i?-1:1}))})}function createComment(a,b,c){window.pendingSync=true;var d=graph.set(null,{type:"/type/comment",creator:"/user/"+app.username,created_at:new Date,content:b,node:a._id,document:a.get("document")._id});graph.sync(function(e){window.pendingSync=false;e?c(e,null):c(null,d)})}
function removeComment(a,b){window.pendingSync=true;graph.del(a._id);graph.sync(function(c){window.pendingSync=false;b(c)})}function loadDocument(a,b,c,d){$.ajax({type:"GET",url:c?"/documents/"+a+"/"+b+"/"+c:"/documents/"+a+"/"+b,dataType:"json",success:function(e){if(e.error)d(e,null);else{graph.merge(e.graph);d(null,{version:e.version,authorized:e.authorized,published:e.published,doc:graph.get(e.id)})}},error:function(e){d(e,null)}})}
function sortByUpdatedAt(a){return a.sort(function(b,c){var d=b.value.get("updated_at"),e=c.value.get("updated_at");return d===e?0:d>e?-1:1})}function loadUserProfile(a,b){$.ajax({type:"GET",url:"/documents/"+a,dataType:"json",success:function(c){var d=new Data.Graph(seed);d.merge(c.graph);c=d.find({"type|=":"/type/document"});b(null,{documents:sortByUpdatedAt(c),user:d.get("/user/"+a)})},error:function(c){b(c)}})}
function loadDashboard(a,b){this.query=a;$.ajax({type:"GET",url:"/dashboard.json",dataType:"json",success:function(c){var d=new Data.Graph(seed);d.merge(c.graph);var e=d.find({"type|=":"/type/document"});b(null,{documents:sortByUpdatedAt(e),user:d.get("/user/"+session.username),bins:c.bins})},error:function(c){b(c)}})}
function loadExplore(a){var b=(new Data.Graph(seed)).connect("ajax");$.ajax({type:"GET",url:"/networks/recent",dataType:"json",success:function(c){b.merge(c.graph);b.find({"type|=":"/type/document"});c=b.find({type:"/type/network"});a(null,{networks:sortByUpdatedAt(c)})},error:function(c){a(c)}})}
function loadNetwork(a,b){$.ajax({type:"GET",url:"/network/"+a+".json",dataType:"json",success:function(c){var d=new Data.Graph(seed);d.merge(c.graph);var e=d.find({type:"/type/network"}).first(),g={};g[e._id]=e.toJSON();graph.merge(g,false);b(null,{members:d.find({type:"/type/user"}),network:graph.get(e._id),documents:sortByUpdatedAt(d.find({type:"/type/document"})),isMember:c.isMember,transloadit_params:config.transloadit.network_cover})},error:function(c){b(c)}})}
function loadCollaborationConfirmation(a,b){graph.fetch({type:"/type/collaborator",tan:a,document:{}},function(c,d){if(c)return b(c);b(null,{tan:a,document:d.select(function(e){return e.types().get("/type/document")}).first(),collaborator:d.select(function(e){return e.types().get("/type/collaborator")}).first()})})}function search(a,b){$.ajax({type:"GET",url:"/fulltextsearch?q="+encodeURI(a),dataType:"json",success:function(c){b(null,c)},error:function(c){b(c,null)}})}
function documentURL(a){return""+a.get("creator")._id.split("/")[2]+"/"+a.get("name")}function userName(a){return a._id.split("/")[2]}function deleteDocument(a,b){graph.del(a._id);setTimeout(function(){b(null)},300);notifier.notify(Notifications.DOCUMENT_DELETED)}function byCreatedAt(a,b){var c=a.value.get("created_at"),d=b.value.get("created_at");return c===d?0:c>d?-1:1}
function checkDocumentName(a,b){RegExp(graph.get("/type/document").get("properties","name").validator).test(a)?$.ajax({type:"GET",url:"/documents/"+app.username+"/"+a,dataType:"json",success:function(c){b(c.status==="error")},error:function(){b(true)}}):b(false)}function updateDocumentName(a,b,c){checkDocumentName(b,function(d){if(d){a.set({name:b});c(null)}else c(Error("Sorry, this name is already taken."))})}
function subscribeDocument(a,b){graph.set(null,{type:"/type/subscription",user:"/user/"+app.username,document:a._id});a.set({subscribed:true,subscribers:a.get("subscribers")+1});a._dirty=false;setTimeout(function(){b(null)},300)}function unsubscribeDocument(a,b){graph.fetch({type:"/type/subscription",user:"/user/"+app.username,document:a._id},function(c,d){graph.del(d.first()._id);a.set({subscribed:false,subscribers:a.get("subscribers")-1});a._dirty=false;b(c)})}
function loadSubscribers(a,b){graph.fetch({type:"/type/subscription",document:a._id},function(c,d){if(c)return b(c,null);b(c,{subscriptions:d})})}function loadVersions(a,b){graph.fetch({type:"/type/version",document:a._id},function(c,d){if(c)return b(c,null);b(null,{versions:d.sort(byCreatedAt)})})}
function loadPublish(a,b){graph.fetch({type:"/type/network"},function(c,d){if(c)return b(c,null);graph.fetch({type:"/type/publication",document:a._id},function(e,g){if(e)return b(e,null);var h=new Data.Hash;g.each(function(i){i=i.get("network")._id;h.set(i,d.get(i))});b(null,{availableNetworks:d,networks:h,document:a})})})}
function publishDocument(a,b,c,d){$.ajax({type:"POST",url:"/publish",data:JSON.stringify({document:a._id,networks:b,remark:c}),contentType:"application/json",dataType:"json",success:function(e){if(e.error)d(e.error,null);else{graph.merge(e.graph);d(null,e)}},error:function(e){d(e,null)}})}
function unpublishDocument(a,b){$.ajax({type:"POST",url:"/unpublish",data:JSON.stringify({document:a._id}),contentType:"application/json",dataType:"json",success:function(c){if(c.error)b(c.error,null);else{graph.merge(c.graph);b(null,c)}},error:function(c){b(c,null)}})}function removeVersion(a,b,c){window.pendingSync=true;graph.del(b);graph.sync(function(){window.pendingSync=false;c(null)})}function networkSlug(a){return a._id.split("/")[2]}
function joinNetwork(a,b){$.ajax({type:"POST",url:"/network/"+a+"/join",dataType:"json",success:function(){b(null)},error:function(c){b(c)}})}function leaveNetwork(a,b){$.ajax({type:"PUT",url:"/network/"+a+"/leave",dataType:"json",success:function(){b(null)},error:function(c){b(c)}})}
function login(a,b,c){$.ajax({type:"POST",url:"/login",data:{username:a,password:b},dataType:"json",success:function(d){if(d.status==="error")c({error:"authentication_failed"},null);else{graph.merge(d.seed);app.username=d.username;c(null,d.username)}},error:function(){c({error:"authentication_failed"},null)}})}function logout(a){$.ajax({type:"POST",url:"/logout",dataType:"json",success:function(){a(null)},error:function(b){a(b)}})}
function createUser(a,b,c,d,e){$.ajax({type:"POST",url:"/register",data:{username:a,name:b,email:c,password:d},dataType:"json",success:function(g){g.status==="error"?e("error",g):e(null,g)},error:function(){console.log("Unknown error. Couldn't create user.")}})}function requestPasswordReset(a,b){$.ajax({type:"POST",url:"/recover_password",data:{username:a},dataType:"json",success:function(c){c.error?b(c.error,null):b(null,c)},error:function(c){b(c,null)}})}
function resetPassword(a,b,c,d){$.ajax({type:"POST",url:"/reset_password",data:{username:a,tan:b,password:c},dataType:"json",success:function(e){e.status==="error"?d(e.message,null):d(null,e)},error:function(e){d(e,null)}})}function getPublishState(a){return a.get("published_version")?a.get("published_on")===a.get("updated_at")?"published":"published-outdated":"unpublished"}function loggedIn(){return!!(app||session).username}function currentUser(){return graph.get("/user/"+session.username)}
function isCurrentUser(a){return(app||session).username===a._id.split("/")[2]}function invite(a,b,c,d){$.ajax({type:"POST",url:"/invite",data:{email:a,document:b._id,mode:c},dataType:"json",success:function(e){e.error?d(e.error):d(null)},error:function(e){d(e)}})}function getCollaborators(a,b){graph.fetch({type:"/type/collaborator",document:a._id},function(c,d){b(c,d)})}function removeCollaborator(a,b){window.pendingSync=true;graph.del(a);graph.sync(function(c){window.pendingSync=false;b(c)})}
function changeCollaboratorMode(a,b,c){window.pendingSync=true;graph.get(a).set({mode:b});graph.sync(function(d){window.pendingSync=false;c(d)})}function getNotifications(){return graph.find({"type|=":"/type/notification",recipient:"/user/"+session.username}).sort(function(a,b){a=a.value.get("created_at");b=b.value.get("created_at");return a===b?0:a>b?-1:1})}
function loadNotifications(a){$.ajax({type:"GET",url:"/notifications",dataType:"json",success:function(b){var c={};_.each(b,function(d,e){graph.get(e)||(c[e]=d)});graph.merge(c);a(null)}})}
function importFromPandoc(a,b){function c(f,k){if(typeof f==="string")return k[f]();else{for(var m in f)if(f.hasOwnProperty(m))break;return k[m](f[m])}}function d(f){var k=r[r.length-1].all("children");k.set(f._id,f,k.length)}function e(){if(!q){q=graph.set(null,{type:"/type/text",content:" ",document:a._id});d(q)}}function g(f){q.set({content:q.get("content")+f})}function h(){q=null}function i(f){return function(k){return"<"+f+">"+l(k)+"</"+f+">"}}function j(f){return function(){return f}}function l(f){for(var k=
"",m=0,o=f.length;m<o;m++)k+=c(f[m],v);return k}function n(f){return f.replace(/<[^>]*>/g,"")}function p(f){for(var k="",m=0,o=f.length;m<o;m++)k+=c(f[m],t);return k}function u(f){for(var k=0,m=f.length;k<m;k++)c(f[k],w)}var r=[a],q=null,v={Str:function(f){return f},Emph:i("em"),Strong:i("strong"),Strikeout:l,Superscript:l,Subscript:l,SmallCaps:l,Quoted:function(f){return l(f[1])},Cite:function(f){return l(f[1])},Code:function(f){return"<code>"+f[1]+"</code>"},Space:j(" "),EmDash:j("\u2014"),EnDash:j("\u2013"),
Apostrophe:j("\u2019"),Ellipses:j("\u2026"),LineBreak:j("<br />"),Math:j(" <em>Inline Math is not supported yet.</em> "),RawInline:j(""),Link:function(f){return'<a href="'+f[1][0]+'">'+l(f[0])+"</a>"},Image:j(" <em>Inline Images are not supported yet.</em> "),Note:j(" <em>Footnotes are not supported yet.</em> ")},w={Plain:function(f){this.Para(f)},Para:function(f){for(;["Space","LineBreak"].indexOf(f[0])>=0;)f.shift();for(;_.keys(f[0])[0]==="Image";){var k=f[0].Image[1][0],m=k[0];h();for(graph.set(null,
{type:"/type/image",url:k,caption:n(l(m)),document:a._id});["Space","LineBreak"].indexOf(f[0])>=0;)f.shift()}if(f.length){e();g("<p>"+l(f)+"</p>")}},CodeBlock:function(f){h();var k=["javascript","python","ruby","php","html","css","haskell","coffeescript","java","c"],m="null";_.each(f[0][1],function(o){o=o.toLowerCase();if(k.indexOf(o)>=0)m=o});f=graph.set(null,{type:"/type/code",language:m,content:s.util.escape(f[1]),document:a._id});d(f)},RawBlock:function(){h()},BlockQuote:function(f){h();f=graph.set(null,
{type:"/type/quote",content:n(p(f)),author:"",document:a._id});d(f)},OrderedList:function(f){e();g(t.OrderedList(f))},BulletList:function(f){e();g(t.BulletList(f))},DefinitionList:function(f){_.each(f,function(k){e();g("<p><strong>"+l(k[0])+"</strong></p>");_.each(k[1],u)})},Header:function(f){h();var k=f[0];for(f=graph.set(null,{type:"/type/section",document:a._id,name:n(l(f[1]))});r.length>k;)r.pop();d(f);r.push(f)},HorizontalRule:function(){h()},Table:function(){h()},Null:function(){h()}},t={Plain:function(f){return this.Para(f)},
Para:function(f){return l(f)},CodeBlock:j(""),RawBlock:j(""),BlockQuote:j(""),OrderedList:function(f){return"<ol>"+_.map(f[1],function(k){return"<li>"+p(k)+"</li>"}).join("")+"</ol>"},BulletList:function(f){return"<ul>"+_.map(f,function(k){return"<li>"+p(k)+"</li>"}).join("")+"</ul>"},DefinitionList:j(""),Header:function(f){return"<strong>"+l(f[1])+"</strong>"},HorizontalRule:j(""),Table:j(""),Null:j("")};u(b[1])}
function importFromText(a,b,c,d){$.ajax({type:"POST",url:"/parse",contentType:"application/json",dataType:"json",data:JSON.stringify({format:b,text:c}),success:function(e){try{importFromPandoc(a,e)}catch(g){d(g);return}d()},error:function(e){d(e)}})}
s.Router=Backbone.Router.extend({initialize:function(){this.route(":username","user",app.user);this.route(":username/:docname/:p1/:p2/:p3","node",this.loadDocument);this.route(":username/:docname/:p1/:p2","node",this.loadDocument);this.route(":username/:docname/:p1","node",this.loadDocument);this.route(":username/:docname","node",this.loadDocument);this.route("reset/:username/:tan","reset",app.resetPassword);this.route("subscribed","subscribed",app.subscribedDocs);this.route("recent","recent",app.recentDocs);
this.route("collaborate/:tan","collaborate",app.collaborate);this.route("search/:searchstr","search",app.searchDocs);this.route("register","register",app.register);this.route("recover","recover",app.recoverPassword);this.route("new","new",app.newDocument);this.route("import","import",app["import"]);this.route("settings","settings",app.userSettings);this.route("dashboard","dashboard",app.dashboard);this.route("explore","explore",app.explore);this.route("network/:network","network",app.network);this.route("search",
"search",app.search);this.route("","home",this.landingPage)},landingPage:function(){session&&session.username?app.dashboard():app.home()},loadDocument:function(a,b,c,d,e){var g=!c||c.indexOf("_")>=0?null:c;app.loadDocument(a,b,g,g?d:c,g?e:d)}});
var StateMachine={transitionTo:function(a){if(this.state!==a&&this.invokeForState("leave",a)!==false){this.state=a;this.invokeForState("enter")}},invokeForState:function(a){for(var b=Array.prototype.slice.call(arguments,1),c=this;c;){c=c.constructor;if(c.states&&c.states[this.state]&&c.states[this.state][a])return c.states[this.state][a].apply(this,b);c=c.__super__}}};
s.views.UserStatus=Backbone.View.extend(_.extend({},StateMachine,{id:"user_status",events:{"click .logout":"logout","submit #login-form":"login","click .toggle.notifications":"toggleNotifications","click #event_notifications a .notification":"hideNotifications","click a.open-notification":"openNotification"},openNotification:function(a){a=$(a.currentTarget).attr("href");var b=a.replace("#","/").split("/"),c=b[1],d=b[2],e=!b[3]||b[3].indexOf("_")>=0?null:b[3];app.loadDocument(c,d,e,e?b[4]:b[3],e?b[5]:
b[4]);router.navigate(a);return false},initialize:function(){this.notificationsActive=false;this.state=session.username?"logged_in":"logged_out";setInterval(function(){loadNotifications(function(){})},3E4)},transitionTo:function(){var a=StateMachine.transitionTo.apply(this,arguments);this.render();return a},render:function(){$(this.el).html(this.invokeForState("render"));return this},login:function(){var a=this.$("#login-user").val(),b=this.$("#login-password").val();login(a,b,function(c){if(c)return notifier.notify(Notifications.AUTHENTICATION_FAILED);
window.location.reload()});return false},logout:function(){logout(_.bind(function(a){a||window.location.reload()},this));return false},showNotifications:function(){$(this.el).addClass("notifications-active");this.notificationsActive=true},hideNotifications:function(){graph.find({"type|=":"/type/notification",recipient:"/user/"+app.username}).select(function(a){return!a.get("read")}).each(function(a){a.set({read:true})});$(this.el).removeClass("notifications-active");this.notificationsActive=false},
toggleNotifications:function(){this.notificationsActive?this.hideNotifications():this.showNotifications();return false}}),{states:{logged_in:{render:function(){var a=getNotifications();return s.util.tpl("user_navigation",{notifications:a,user:currentUser(),count:a.select(function(b){return!b.get("read")}).length,notifications_active:true})}},logged_out:{render:function(){return s.util.tpl("login_form")}}}});
s.views.Home=Backbone.View.extend({events:{"click .watch-intro":"watchIntro"},watchIntro:function(){$("#startpage .intro").height("400");$("#startpage .intro .intro-text").fadeOut();setTimeout(function(){$("#startpage .intro .video").html('<video autoplay width="920" height="400" controls><source src="http://substance.io/videos/substance_intro.mp4" type=\'video/mp4; codecs="avc1.42E01E, mp4a.40.2"\'><source src="http://substance.io/videos/substance_intro.ogv" type="video/ogg" /> </video>');setTimeout(function(){$("#startpage .intro .video").fadeIn()},
400)},1E3);return false},render:function(){$(this.el).html(s.util.tpl("home",{}));(function(){var a=document.createElement("script"),b=document.getElementsByTagName("script")[0];a.type="text/javascript";a.async=true;a.src="http://api.flattr.com/js/0.6/load.js?mode=auto";b.parentNode.insertBefore(a,b)})();return this}});s.views.Results=Backbone.View.extend({render:function(){$(this.el).html(s.util.tpl("results",this.model));return this}});
s.views.UserList=Backbone.View.extend({className:"user-list",initialize:function(){},render:function(){$(this.el).html(s.util.tpl("user_list",{users:this.model.members}));return this}});
s.views.Signup=Backbone.View.extend({id:"signup",className:"page-content",events:{"submit form":"registerUser"},render:function(){$(this.el).html(s.util.tpl("signup",{}));return this},registerUser:function(){$(".page-content .input-message").empty();$("#registration_error_message").empty();$(".page-content input").removeClass("error");var a=this.$("#signup_user").val(),b=this.$("#signup_name").val(),c=this.$("#signup_email").val(),d=this.$("#signup_password").val();createUser(a,b,c,d,function(e,g){if(e)if(g.field===
"username"){$("#signup_user").addClass("error");$("#signup_user_message").html(g.message)}else $("#registration_error_message").html(g.message);else{notifier.notify(Notifications.AUTHENTICATED);window.location.href="/"+g.username}});return false}});
s.views.Dashboard=Backbone.View.extend({events:{"click .toggle-bin":"__toggleBin"},__toggleBin:function(a){this.activeCategory=$(a.currentTarget).attr("data-category");this.activeBin=$(a.currentTarget).attr("data-bin");this.updateResults();this.render()},updateResults:function(){var a=this.model.documents.select(_.bind(function(b){return _.include(this.model.bins[this.activeCategory][this.activeBin].documents,b._id)},this));this.results=new s.views.Results({model:{documents:a},id:"results"})},initialize:function(){this.activeBin=
this.activeCategory="user";this.updateResults()},render:function(){$(this.el).html(s.util.tpl("dashboard",{user:this.model.user,bins:this.model.bins,activeBin:this.activeBin}));this.$(this.results.render().el).appendTo(this.el);return this}});
s.views.UserProfile=Backbone.View.extend({events:{},initialize:function(){this.results=new s.views.Results({model:this.model,id:"results"})},render:function(){$(this.el).html(s.util.tpl("user_profile",{user:this.model.user}));this.$(this.results.render().el).appendTo(this.el);return this}});s.views.Explore=Backbone.View.extend({render:function(){$(this.el).html(s.util.tpl("explore",this.model));return this}});
s.views.Import=Backbone.View.extend({id:"import",className:"page-content",events:{"submit form":"importDocument"},render:function(){$(this.el).html(s.util.tpl("import",{}));setTimeout(function(){CodeMirror.fromTextArea(this.$("textarea").get(0),{lineNumbers:true,theme:"elegant"}).focus()},10);return this},importDocument:function(a){a.preventDefault();a.stopPropagation();var b=this.$("#new_document_name").val(),c=this.$("#format").val(),d=this.$("#text").val(),e=s.util.slug(b);checkDocumentName(e,
_.bind(function(g){if(g){notifier.notify(Notifications.BLANK_DOCUMENT);var h=createDoc("/type/article",e,b);importFromText(h,c,d,function(i){i&&console.error(i);graph.sync(function(){router.navigate(documentURL(h),true)})})}else{this.$("#new_document_name").addClass("error");this.$("#new_document_name_message").html("This document name is already taken.")}},this))}});
s.views.Network=Backbone.View.extend({events:{"click .join-network":"__joinNetwork","click .leave-network":"__leaveNetwork","click .toggle-documents":"__toggleDocuments","click .toggle-members":"__toggleMembers","change .image-file":"__upload"},__joinNetwork:function(){joinNetwork(networkSlug(this.model.network),_.bind(function(){this.reload()},this));return false},__leaveNetwork:function(){leaveNetwork(networkSlug(this.model.network),_.bind(function(){this.reload()},this));return false},__toggleDocuments:function(){this.mode=
"documents";this.reload()},__toggleMembers:function(){this.mode="members";this.reload()},__upload:function(){this.$(".upload-image-form").submit()},initializeUploadForm:function(){_.bindAll(this,"onStart","onProgress","onError");this.$(".upload-image-form").transloadit({modal:false,wait:true,autoSubmit:false,onStart:this.onStart,onProgress:this.onProgress,onError:this.onError,onSuccess:_.bind(function(a){a.results.web_version&&a.results.web_version[1]&&a.results.web_version[1].url?this.onSuccess(a):
this.onInvalid()},this)})},makeEditable:function(){var a=this;this.$name=$("#network_header .title").unbind();this.$name.click(function(){editor.activate(a.$name,{placeholder:"Enter Title",markup:false,multiline:false});editor.bind("changed",function(){a.model.network.set({name:editor.content()})})});this.$descr=$("#network_header .descr").unbind();this.$descr.click(function(){editor.activate(a.$descr,{placeholder:"Enter Sheet Description",controlsTarget:$("#sheet_editor_controls")});editor.bind("changed",
function(){a.model.network.set({descr:editor.content()})})});this.initializeUploadForm()},onStart:function(){this.$(".image-progress").show();this.$(".image-progress .label").html("Uploading &hellip;");this.$(".progress-bar").css("width","0%")},onProgress:function(a,b){var c=Math.max(0,parseInt(a/b*100));c||(c=0);this.$(".image-progress .label").html("Uploading &hellip; "+c+"%");this.$(".progress-bar").css("width",c+"%")},onSuccess:function(a){this.model.network.set({cover:a.results.web_version[1].url});
this.$(".image-progress").hide();$(".upload-image-form img").attr("src",a.results.web_version[1].url)},onError:function(){},onInvalid:function(){this.$(".image-progress .label").html("Invalid image. Skipping &hellip;");this.$(".image-progress").hide();setTimeout(_.bind(function(){this.$(".info").show()},this),3E3)},initialize:function(){this.documents=new s.views.Results({model:this.model,id:"results"});this.members=new s.views.UserList({model:this.model,id:"members"});this.mode="documents";_.bindAll(this,
"makeEditable")},reload:function(){loadNetwork(networkSlug(this.model.network),_.bind(function(a,b){this.model=b;this.documents=new s.views.Results({model:this.model,id:"results"});this.members=new s.views.UserList({model:this.model,id:"members"});this.render()},this))},render:function(){$(this.el).html(s.util.tpl("network",_.extend(this.model,{mode:this.mode})));this.$(this[this.mode].render().el).appendTo(this.el);isCurrentUser(this.model.network.get("creator"))&&setTimeout(this.makeEditable,500);
return this}});s.views.Search=Backbone.View.extend({id:"search",events:{"submit form":"performSearch"},render:function(){$(this.el).html(s.util.tpl("search"));return this},performSearch:function(a){a.preventDefault();a.stopPropagation();a=this.$("#search_string").val();search(a,_.bind(function(b,c){if(b)console.log(b);else{console.log(b,c);this.$("#results").html(s.util.tpl("search_results",{users:c.users,documents:c.documents}))}},this))}});
s.views.UserSettings=Backbone.View.extend({events:{"submit form":"updateUser"},updateUser:function(){this.$("#user_password").val()===""||this.$("#user_password").val()===this.$("#user_password_confirmation").val()?$.ajax({type:"POST",url:"/updateuser",data:{username:this.$("#user_username").val(),name:this.$("#user_name").val(),email:this.$("#user_email").val(),password:this.$("#user_password").val(),website:this.$("#user_website").val(),company:this.$("#user_company").val(),location:this.$("#user_location").val()},
dataType:"json",success:function(a){if(a.status==="error")notifier.notify({message:"An error occured. Check your input",type:"error"});else{graph.merge(a.seed);app.username=a.username;app.render();app.document.closeDocument();app.browser.load(app.query());app.browser.bind("loaded",function(){app.toggleView("browser")});router.navigate(app.username)}},error:function(){notifier.notify({message:"An error occured. Check your input",type:"error"})}}):notifier.notify({message:"Password and confirmation do not match.",
type:"error"});return false},initialize:function(){},render:function(){$(this.el).html(s.util.tpl("user_settings",{user:graph.get("/user/"+app.username)}));return this}});
s.views.NewDocument=Backbone.View.extend({id:"new_document",className:"page-content",events:{"submit form":"createDocument"},render:function(){$(this.el).html(s.util.tpl("new_document",{}));return this},createDocument:function(a){a.preventDefault();a.stopPropagation();var b=this.$("#new_document_name").val(),c=s.util.slug(b);checkDocumentName(c,_.bind(function(d){if(d){notifier.notify(Notifications.BLANK_DOCUMENT);var e=createDoc("/type/article",c,b);graph.sync(function(){router.navigate(documentURL(e),
true)})}else{this.$("#new_document_name").addClass("error");this.$("#new_document_name_message").html("This document name is already taken.")}},this))}});s.views.Header=Backbone.View.extend({id:"header",initialize:function(){this.userStatus=new s.views.UserStatus({})},render:function(){$(this.el).html(s.util.tpl("header",{user:graph.get("/user/"+session.username)}));$(this.userStatus.render().el).appendTo(this.el);return this}});
s.views.Application=Backbone.View.extend({events:{"click .toggle-view":"toggleView","click .toggle-startpage":"home"},toggleView:function(a){a.preventDefault();a.stopPropagation();a=$(a.currentTarget);var b=a.attr("href").replace(/^\//,"");$(".toggle-view.active").removeClass("active");a.addClass("active");router.navigate(b,true)},initialize:function(){_.bindAll(this);this.header=new s.views.Header({});if(session.username){graph.merge(session.seed);this.username=session.username}},render:function(){$(this.header.render().el).prependTo(this.el);
return this},scrollTo:function(a){(a=$("#"+a).offset())&&$("html, body").animate({scrollTop:a.top-90},"slow");return false},replaceMainView:function(a,b){$("body").removeClass().addClass("current-view "+a);this.mainView&&this.mainView.remove();this.mainView=b;$(b.el).appendTo(this.$("#main"))},explore:function(){loadExplore(_.bind(function(a,b){this.replaceMainView("explore",(new s.views.Explore({model:b,id:"explore"})).render())},this))},network:function(a){loadNetwork(a,_.bind(function(b,c){this.replaceMainView("network",
(new s.views.Network({model:c,id:"network"})).render())},this))},search:function(a){search(a,_.bind(function(b,c){this.replaceMainView("search",(new s.views.Search({model:c,id:"search"})).render())},this))},home:function(){router.navigate("");this.replaceMainView("home",(new s.views.Home({id:"home"})).render());return false},user:function(a){loadUserProfile(a,_.bind(function(b,c){this.replaceMainView("user_profile",(new s.views.UserProfile({model:c,id:"user_profile"})).render())},this))},dashboard:function(){router.navigate("dashboard");
loadDashboard({type:"user",value:session.username},_.bind(function(a,b){this.replaceMainView("dashboard",(new s.views.Dashboard({model:b,id:"dashboard"})).render())},this))},collaborate:function(a){loadCollaborationConfirmation(a,_.bind(function(b,c){this.replaceMainView("confirm_collaboration",(new s.views.ConfirmCollaboration({model:c,id:"confirm_collaboration"})).render())},this))},recoverPassword:function(){this.replaceMainView("recover_password",(new s.views.RecoverPassword({id:"recover_password"})).render())},
resetPassword:function(a,b){this.replaceMainView("reset_password",(new s.views.ResetPassword({username:a,tan:b,id:"reset_password"})).render())},newDocument:function(){if(!head.browser.webkit&&!head.browser.mozilla){alert("You need to use a Webkit based browser (Google Chrome, Safari) in order to write documents. In future, other browers will be supported too.");return false}this.replaceMainView("new_document",(new s.views.NewDocument({id:"new_document"})).render())},register:function(){this.replaceMainView("signup",
(new s.views.Signup({id:"signup"})).render())},userSettings:function(){this.replaceMainView("user_settings",(new s.views.UserSettings({id:"user_settings"})).render())},"import":function(){this.replaceMainView("import",(new s.views.Import({id:"import"})).render())},loadDocument:function(a,b,c,d,e){var g=_.bind(function(h){this.replaceMainView("document",(new s.views.Document(_.extend(h,{id:"document_view"}))).render())},this);loadDocument(a,b,c,_.bind(function(h,i){if(h)return $("#main").html('<div class="notification error">'+
h.message+"</div>");g({model:i.doc,authorized:i.authorized,version:i.version,published:i.published});if(e){var j=app.mainView.node.nodes[d.replace(/_/g,"/")];j.selectThis();j.comments.toggle()}else d&&this.scrollTo(d)},this))}});
s.views.Comments=Backbone.View.extend({className:"comments-wrapper",events:{"click a.create-comment":"createComment","click a.remove-comment":"removeComment","click .comment-content":"activateEditor"},initialize:function(a){this.expanded=false;this.node=a.node},toggle:function(){this.expanded?this.contract():this.expand()},expand:function(){$(this.el).addClass("expanded");this.expanded=true;this.comments?this.scrollTo():this.load(_.bind(function(){this.scrollTo()},this))},contract:function(){$(this.el).removeClass("expanded");
this.expanded=false},scrollTo:function(){var a=$(this.el).offset();$("html, body").animate({scrollTop:a.top-100},"slow")},load:function(a){loadComments(this.model,_.bind(function(b,c){if(!b){this.comments=c;this.render();a&&a()}},this))},createComment:function(a){a.preventDefault();a=this.model;var b=this.commentEditor.content(),c=this;createComment(a,b,function(){c.load(function(){c.render()})})},removeComment:function(a){a.preventDefault();a=graph.get($(a.currentTarget).attr("comment"));var b=this;
removeComment(a,function(){b.load(function(){b.render()})})},activateEditor:function(a){a.preventDefault();a.stopPropagation();a=this.$(".comment-content");this.commentEditor=new Proper;this.commentEditor.activate(a,{multiline:true,markup:true,placeholder:"Enter Comment"})},render:function(){var a=$(this.el),b=this.comments;if(b)a.html(s.util.tpl("comments",{doc:this.model.get("document"),node:this.model,comments:b,version:this.node?this.node.root.document.version:""}));return this}});
s.views.Controls=Backbone.View.extend(_.extend({},StateMachine,{className:"controls",events:{"click .insert a":"insert","click .move a":"move"},initialize:function(a){this.state="read";this.root=a.root;this.level=a.level;this.position=a.position},transitionTo:function(a){StateMachine.transitionTo.call(this,a);this.render()},getPositionFromEl:function(a){var b=a.attr("data-parent");a=a.attr("data-after");return new Position(graph.get(b),a?graph.get(a):null)},insert:function(a){a.preventDefault();a.stopPropagation();
var b=$(a.target);a=this.getPositionFromEl(b);b=b.attr("data-type");createNode(b,a)},move:function(a){a.preventDefault();a.stopPropagation();a=this.getPositionFromEl($(a.target));moveChild(this.root.movedParent,this.root.movedNode,a);this.root.transitionTo("write")},render:function(){$(this.el).html(this.invokeForState("render"));return this}}),{states:{read:{render:function(){return""}},write:{render:function(){var a=this,b=new Data.Hash;possibleChildTypes(this.position,this.level).each(function(c,
d){if(d!=="/type/section"||c.length==1)b.set(d,_.last(c));else{var e=a.level;b.set(d,_.map(c,function(g){g.level=e;e++;return g}))}});return s.util.tpl("controls_insert",{childTypes:b})}},move:{render:function(){return s.util.tpl("controls_move",{})}},moveTarget:{render:function(){var a=this.root.movedNode,b=this.level,c=moveTargetPositions(a,this.position,this.level);c=isSection(a)?_.map(c,function(d){d.level=b;b++;return d}):[_.last(c)];return s.util.tpl("controls_movetarget",{moveTargets:c})}}}});
s.views.Node=Backbone.View.extend(_.extend({},StateMachine,{className:"content-node",attributes:{draggable:"false"},initialize:function(a){this.state="read";this.parent=a.parent;this.level=a.level;if(this.root=a.root)this.root.nodes[this.model._id]=this;else{this.nodes={};this.root=this;this.document=a.document}this.comments=new s.views.Comments({model:this.model,node:this});this.afterControls=new s.views.Controls({root:this.root,level:this.level,model:this.parent,position:new Position(this.parent,
this.model)});$(this.el).attr({id:this.model.html_id});_.bindAll(this,"lastChildChanged");this.model.bind("last-child-changed",this.lastChildChanged)},transitionTo:function(a){StateMachine.transitionTo.call(this,a);this.state===a&&this.afterControls.transitionTo(a)},lastChildChanged:function(){this.afterControls.render();this.parent&&isLastChild(this.parent,this.model)&&this.parent.trigger("last-child-changed")},events:{"click .toggle-comments":"toggleComments","click .remove-node":"removeNode","click .toggle-move-node":"toggleMoveNode",
click:"selectThis",mouseover:"highlight",mouseout:"unhighlight"},toggleComments:function(a){a.preventDefault();a.stopPropagation();this.selectThis();this.comments.toggle()},removeNode:function(a){a.preventDefault();a.stopPropagation();removeChild(this.parent,this.model)},toggleMoveNode:function(a){a.preventDefault();a.stopPropagation();if(this.state==="move")this.root.transitionTo("write");else{this.root.transitionTo("read");this.transitionTo("move");this.root.movedNode=this.model;this.root.movedParent=
this.parent;this.root.transitionTo("moveTarget")}},selectThis:function(a){a&&a.stopPropagation();this.root?this.root.selectNode(this):this.selectNode(this)},highlight:function(a){a.preventDefault();$(this.el).addClass("active")},unhighlight:function(a){a.preventDefault();$(this.el).removeClass("active")},select:function(){$(this.el).addClass("selected")},deselect:function(){$(this.el).removeClass("selected")},focus:function(){},makeEditable:function(a,b,c,d,e){c=c||"";d=_.extend({placeholder:c,markup:false,
multiline:false,codeFontFamily:'Monaco, Consolas, "Lucida Console", monospace'},d||{});e=e||function(i,j,l){var n={};n[j]=l;updateNode(i,n)};var g=this,h=this.model.get(b);if(h)d.markup?$(a).html(h):$(a).text(s.util.unescape(h));else $(a).html("&laquo; "+c+" &raquo;").addClass("empty");$(a).addClass("editable").click(function(){if(g.state==="write"){window.editor.activate($(a),d);window.editor.bind("changed",function(){e(g.model,b,window.editor.content())})}});return $(a)},render:function(){this.operationsEl=
$(s.util.tpl("operations",{commentCount:this.model.get("comment_count")||""})).appendTo(this.el);this.contentEl=$('<div class="content" />').appendTo(this.el);if(this.comments)this.commentsEl=$(this.comments.render().el).appendTo(this.el);return this}}),{states:{read:{enter:function(){},leave:function(){}},write:{enter:function(){},leave:function(){}},move:{enter:function(){$(this.el).addClass("being-moved")},leave:function(a){if(a==="moveTarget")return false;$(this.el).removeClass("being-moved")}},
moveTarget:{enter:function(){},leave:function(){}}},subclasses:{},define:function(a,b,c){c=c||{};var d=this.extend(b,c);_.each(_.isArray(a)?a:[a],function(e){this.subclasses[e]=d},this);return d},create:function(a){var b=a.model.type._id,c=this.subclasses[b];if(!c)throw Error("Node has no subclass for type '"+b+"'");return new c(a)}});
s.views.NodeList=Backbone.View.extend({className:"node-list",initialize:function(a){this.level=a.level;this.root=a.root;_.bindAll(this,"addChild");this.model.bind("added-child",this.addChild);this.firstControls=new s.views.Controls({root:this.root,model:this.model,position:new Position(this.model,null)});var b=this.childViews=[];this.model.get("children").each(_.bind(function(c){b.push(this.createChildView(c))},this))},remove:function(){this.model.unbind("added-child",this.addChild);this.eachChildView(function(a){a.remove()});
$(this.el).remove()},eachChildView:function(a){_.each(this.childViews,a)},transitionTo:function(a){function b(c){c.transitionTo(a)}b(this.firstControls);this.eachChildView(b)},addChild:function(a,b){var c=this.createChildView(a),d=this.renderChildView(c);this.childViews.splice(b,0,c);d.insertAfter(b===0?this.firstControls.el:this.childViews[b-1].afterControls.el);c.transitionTo("write");c.selectThis();c.focus()},createChildView:function(a){return s.views.Node.create({parent:this.model,model:a,level:this.level+
1,root:this.root})},renderChildView:function(a){var b=a.afterControls,c=$([a.render().el,b.render().el]);a.model.bind("removed",_.bind(function(){b.remove();a.remove();this.childViews=_.select(this.childViews,function(d){return d!==a})},this));return c},render:function(){$(this.firstControls.render().el).appendTo(this.el);this.eachChildView(_.bind(function(a){this.renderChildView(a).appendTo(this.el)},this));return this}});
s.views.Node.define("/type/answer",{className:"content-node answer",focus:function(){this.answerEl.click()},render:function(){s.views.Node.prototype.render.apply(this,arguments);this.answerEl=this.makeEditable($('<p class="answer" />'),"content","Enter Answer",{markup:true,multiline:true}).appendTo(this.contentEl);return this}});
s.views.Node.define("/type/code",{className:"content-node code",events:_.extend({"change select":"changeLanguageSelect"},s.views.Node.prototype.events),languages:["JavaScript","Python","Ruby","PHP","HTML","CSS","Haskell","CoffeeScript","Java","C","C++","C#","Other"],modeForLanguage:function(a){return{javascript:"javascript",python:{name:"python",version:3},ruby:"ruby",php:"php",html:"htmlmixed",css:"css",haskell:"haskell",coffeescript:"coffeescript",java:"text/x-java",c:"text/x-csrc","c++":"text/x-c++src",
"c#":"text/x-csharp"}[a]||"null"},changeLanguageSelect:function(){var a=this.languageSelect.val();updateNode(this.model,{language:a});this.codeMirror.setOption("mode",this.modeForLanguage(a))},focus:function(){this.codeMirror.focus()},codeMirrorConfig:{lineNumbers:true,theme:"elegant",indentUnit:2,indentWithTabs:false,tabMode:"shift"},render:function(){var a=this;s.views.Node.prototype.render.apply(this,arguments);this.languageSelect=$(function(c,d){var e="<select>";_.each(d,function(g){var h=g.toLowerCase();
selected=c===h?' selected="selected"':"";e+='<option value="'+h+'"'+selected+">"+g+"</option>"});e+="</select>";return e}(this.model.get("language"),this.languages)).appendTo(this.contentEl);var b=_.extend({},this.codeMirrorConfig,{mode:this.modeForLanguage(this.model.get("language")),value:s.util.unescape(this.model.get("content")||""),readOnly:true,onFocus:function(){a.selectThis()},onBlur:function(){a.codeMirror.setSelection({line:0,ch:0},{line:0,ch:0})},onChange:_.throttle(function(){updateNode(a.model,
{content:s.util.escape(a.codeMirror.getValue())})},500)});this.codeMirror=CodeMirror(this.contentEl.get(0),b);setTimeout(function(){a.codeMirror.refresh()},10);return this}},{states:{write:{enter:function(){s.views.Node.states.write.enter.apply(this);this.codeMirror.setOption("readOnly",false)},leave:function(){s.views.Node.states.write.leave.apply(this);this.codeMirror.setOption("readOnly",true)}}}});
s.views.Node.define(["/type/document","/type/article","/type/story","/type/conversation","/type/manual","/type/qaa"],{className:"content-node document",initialize:function(){s.views.Node.prototype.initialize.apply(this,arguments);delete this.comments;delete this.afterControls;this.nodeList=new s.views.NodeList({model:this.model,level:0,root:this})},events:_.extend({"mouseover .editable":"mouseoverEditable"},s.views.Node.prototype.events),mouseoverEditable:function(a){var b=this.state==="write"?"Click to Edit":
"";$(a.target).attr({title:b})},transitionTo:function(a){StateMachine.transitionTo.call(this,a);this.state===a&&this.nodeList.transitionTo(a)},lastChildChanged:function(){},selectNode:function(a){this.deselectNode();$(this.el).addClass("something-selected");a.select();this.selected=a},deselectNode:function(){if(this.selected){$(this.el).removeClass("something-selected");this.selected.deselect();delete this.selected}},render:function(){s.views.Node.prototype.render.apply(this,arguments);this.$(".content-node-outline").remove();
this.operationsEl.empty();var a=this.model.get("creator"),b=this.model.get("published_on");this.titleEl=this.makeEditable($('<div class="document-title" />'),"title","Enter Title").appendTo(this.contentEl);a=$('<a class="toggle-view" />').attr({href:"/"+a.get("username")}).text(a.get("name")||a.get("username"));this.authorEl=$('<p class="author" />').append(a).appendTo(this.contentEl);this.publishedEl=$('<p class="published" />').text(b?s.util.date(b):"").appendTo(this.contentEl);this.leadEl=this.makeEditable($('<p class="lead" id="document_lead" />'),
"lead","Enter Lead").appendTo(this.contentEl);$('<div class="document-separator" />').appendTo(this.contentEl);this.nodeListEl=$(this.nodeList.render().el).appendTo(this.contentEl);return this}},{states:{write:{enter:function(){s.views.Node.states.write.enter.apply(this);$(this.el).addClass("edit")},leave:function(){s.views.Node.states.write.leave.apply(this);$(this.el).removeClass("edit");window.editor.deactivate()}},moveTarget:{enter:function(){$("#document").addClass("move-mode")},leave:function(){delete this.movedNode;
delete this.movedParent;$("#document").removeClass("move-mode")}}}});
s.views.Node.define("/type/image",{className:"content-node image",events:_.extend({"change .image-file":"upload"},s.views.Node.prototype.events),focus:function(){this.caption.click()},initializeUploadForm:function(){_.bindAll(this,"onStart","onProgress","onError");this.$(".upload-image-form").transloadit({modal:false,wait:true,autoSubmit:false,onStart:this.onStart,onProgress:this.onProgress,onError:this.onError,onSuccess:_.bind(function(a){a.results.web_version&&a.results.web_version[1]&&a.results.web_version[1].url?
this.onSuccess(a):this.onInvalid()},this)})},onStart:function(){this.$(".image-progress").show();this.$(".info").hide();this.$(".image-progress .label").html("Uploading &hellip;");this.$(".progress-bar").css("width","0%")},onProgress:function(a,b){var c=Math.max(0,parseInt(a/b*100));c||(c=0);this.$(".image-progress .label").html("Uploading &hellip; "+c+"%");this.$(".progress-bar").css("width",c+"%")},onSuccess:function(a){updateNode(this.model,{url:a.results.web_version[1].url,original_url:a.results.print_version[1].url,
dirty:true});this.$(".progress-container").hide();this.$(".info").show()},onError:function(){},onInvalid:function(){this.$(".image-progress .label").html("Invalid image. Skipping &hellip;");this.$(".progress-container").hide();setTimeout(_.bind(function(){this.$(".info").show()},this),3E3)},upload:function(){this.$(".upload-image-form").submit()},render:function(){s.views.Node.prototype.render.apply(this);this.imageContent=$('<div class="image-content" />').appendTo(this.contentEl);this.model.get("url")||
this.imageContent.addClass("placeholder");this.img=$("<img />").attr({src:this.model.get("url")||"/images/image_placeholder.png"});$('<a target="_blank" />').attr({href:this.model.get("original_url")}).append(this.img).appendTo(this.imageContent);this.imageEditor=$(s.util.tpl("image_editor",{transloadit_params:config.transloadit.image})).appendTo(this.imageContent);this.initializeUploadForm();this.caption=this.makeEditable($('<div class="caption" />'),"caption","Enter Caption").insertAfter(this.contentEl);
return this}},{states:{write:{enter:function(){s.views.Node.states.write.enter.apply(this);this.img.unwrap()},leave:function(){s.views.Node.states.write.leave.apply(this);this.img.wrap($('<a target="_blank" />').attr({href:this.model.get("original_url")}))}}}});
s.views.Node.define("/type/question",{className:"content-node question",focus:function(){this.questionEl.click()},render:function(){s.views.Node.prototype.render.apply(this,arguments);this.questionEl=this.makeEditable($('<p class="question" />'),"content","Enter Question").appendTo(this.contentEl);return this}});
s.views.Node.define("/type/quote",{className:"content-node quote",focus:function(){this.quoteContentEl.click()},render:function(){s.views.Node.prototype.render.apply(this);var a=$("<blockquote />").appendTo(this.contentEl);this.quoteContentEl=this.makeEditable($('<p class="quote-content" />'),"content","Enter Quote").appendTo($("<div />").appendTo(a));this.quoteAuthorEl=this.makeEditable($('<cite class="quote-author" />'),"author","Enter Author").appendTo($("<div />").appendTo(a));$('<br clear="both" />').appendTo(this.contentEl);
return this}});
s.views.Node.define("/type/resource",{className:"content-node resource",initialize:function(){s.views.Node.prototype.initialize.apply(this,arguments);this.updateUrl=_.throttle(this.updateUrl,500)},focus:function(){this.caption.click()},resourceExists:function(a,b){var c=new Image;c.onload=function(){b(true)};c.onerror=function(){b(false)};c.src=a},updateUrl:function(a){this.resourceExists(a,_.bind(function(b){if(b){console.log("Valid resource: "+a);this.img.attr({src:a});this.status.addClass("image").text("Image");updateNode(this.model,
{url:a})}else this.status.prop({className:"status"}).text("Invalid URL")},this))},render:function(){s.views.Node.prototype.render.apply(this);this.resourceContent=$('<div class="resource-content" />').appendTo(this.contentEl);this.model.get("url")||this.resourceContent.addClass("placeholder");this.img=$("<img />").attr({src:this.model.get("url")||"/images/image_placeholder.png"}).appendTo(this.resourceContent);var a=$(s.util.tpl("resource_editor",{})).appendTo(this.contentEl);this.status=a.find(".status");
this.resourceUrl=a.find(".resource-url").val(this.model.get("url")).keyup(_.bind(function(){this.updateUrl($(this.resourceUrl).val())},this));this.caption=this.makeEditable($('<div class="caption" />'),"caption","Enter Caption").insertAfter(this.contentEl);return this}},{states:{write:{enter:function(){s.views.Node.states.write.enter.apply(this);this.$(".resource-url").removeAttr("readonly")},leave:function(){s.views.Node.states.write.leave.apply(this);this.$(".resource-url").attr({readonly:"readonly"})}}}});
s.views.Node.define("/type/section",{className:"content-node section",initialize:function(a){s.views.Node.prototype.initialize.apply(this,arguments);this.nodeList=new s.views.NodeList({model:this.model,level:a.level,root:this.root})},focus:function(){this.headerEl.click()},remove:function(){this.nodeList.remove();$(this.el).remove()},transitionTo:function(a){s.views.Node.prototype.transitionTo.call(this,a);this.state===a&&this.nodeList.transitionTo(a)},render:function(){s.views.Node.prototype.render.apply(this,
arguments);this.headerEl=this.makeEditable($("<h"+Math.min(6,this.level)+" />"),"name","Enter Section Name").appendTo(this.contentEl);this.nodeListEl=$(this.nodeList.render().el).appendTo(this.contentEl);return this}});
s.views.Node.define("/type/text",{className:"content-node text",focus:function(){$(this.textEl).click()},select:function(){s.views.Node.prototype.select.apply(this);this.$(".proper-commands").show()},deselect:function(){s.views.Node.prototype.deselect.apply(this);this.$(".proper-commands").hide()},render:function(){s.views.Node.prototype.render.apply(this,arguments);this.textEl=this.makeEditable(this.contentEl,"content","Enter Text",{markup:true,multiline:true,controlsTarget:$(this.el)});return this}});
var graph=(new Data.Graph(seed,{dirty:false,syncMode:"push"})).connect("ajax");
$(function(){if(s.util.browserSupported()){window.app=(new s.views.Application({el:"#container"})).render();window.editor=new Proper;window.router=new s.Router({});Backbone.history.start({pushState:true});window.onbeforeunload=function(){if(graph.dirtyNodes().length>0)return"You have unsynced changes, which will be lost."};window.pendingSync=false;graph.bind("dirty",function(){if(!pendingSync){pendingSync=true;setTimeout(function(){$("#sync_state").fadeIn(100);graph.sync(function(a){pendingSync=false;
if(a){confirm("There are conflicted or rejected nodes since the last sync. The workspace will be reset for your own safety. Keep in mind we do not yet support simultaneous editing of one document.");window.location.reload(true)}else setTimeout(function(){$("#sync_state").fadeOut(100)},1500)})},3E3)}})}else{$("#container").html(s.util.tpl("browser_not_supported"));$("#container").show()}});
